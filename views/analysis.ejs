<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= subjectname %> Class Performance | <%= studentClass %>-<%= section %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="/datatable-buttons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
    <!-- jQuery and DataTables JS -->
    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

    <script>
    // Define custom sorting for question numbers BEFORE document ready
    $.fn.dataTable.ext.type.detect.unshift(function (data) {
        if (typeof data === 'string' && data.match(/^q?\d+[a-z]?$/i)) {
            return 'question-num';
        }
        return null;
    });

    $.fn.dataTable.ext.type.order['question-num-pre'] = function (data) {
        if (!data || data === '') return 0;
        
        // Extract question number and sub-question from strings like "q1a", "q1b", "q10c"
        var match = data.match(/^q?(\d+)([a-z]?)$/i);
        if (!match) return 0;
        
        var questionNum = parseInt(match[1]);
        var subQuestion = match[2] ? match[2].toLowerCase() : 'a';
        
        // Convert sub-question letter to number (a=0, b=1, c=2, etc.)
        var subQuestionNum = subQuestion.charCodeAt(0) - 97;
        
        // Return a sortable number: questionNum * 100 + subQuestionNum
        // This ensures q1a=100, q1b=101, q2a=200, q10a=1000, etc.
        return questionNum * 100 + subQuestionNum;
    };

    $(document).ready(function () {
        var persons = <%- JSON.stringify(results || []) %>; // Directly pass results array from EJS
        var classInfo = "<%= terminal %> Terminal Examination\n" +
                    "Class: <%= studentClass %> (<%= section %>)\n" +
                    "Subject: <%= subjectname %>";
        
        // Sort the persons array by question number before passing to DataTable
        persons.sort(function(a, b) {
            var aVal = $.fn.dataTable.ext.type.order['question-num-pre'](a.questionNo);
            var bVal = $.fn.dataTable.ext.type.order['question-num-pre'](b.questionNo);
            return aVal - bVal;
        });
                    
        $("#example").DataTable({
            data: persons,
            responsive: true,
            columns: [
                { 
                    data: "questionNo", 
                    title: "Question No",
                    type: "question-num"
                },
                { data: "correct", title: "Correct" },
                { data: "wrong", title: "Wrong" },
                { data: null, title: "Current",defaultContent: "" },
                { data: "fifty", title: "50% Correct" },
                { data: null, title: "Current",defaultContent: "" },
                { data: "correctabove50", title: "Above 50%" },
                { data: null, title: "Current",defaultContent: "" },
                { data: "correctbelow50", title: "Below 50%" },
                { data: null, title: "Current",defaultContent: "" },
                { 
                    data: "averagePercentage", 
                    title: "Average %",
                    render: function (data, type, row) {
                        return data + "%";
                    }
                },
                { 
                    data: null, 
                    title: "Wrong Percentage", 
                    render: function (data, type, row) {
                        var totalStudents = <%= totalStudent %>;
                        return (row.wrong / totalStudents * 100).toFixed(2) + "%";
                    }
                },
                { data: "totalMarks", title: "Total Obtained" },
                { data: "fullMarks", title: "Full Marks" }
            ],
            dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                 "<'row'<'col-sm-12'tr>>" +
                 "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
                 "<'row'<'col-sm-12'B>>",
            order: [[0, 'asc']], // Sort by Question No column (index 0) in ascending order
            columnDefs: [
                {
                    targets: 0, // Question No column
                    type: 'question-num'
                }
            ],
            buttons: [
                {
                    extend: "copy",
                    className: "btn btn-outline-primary",
                    messageTop: classInfo
                },
                {
                    extend: "csv",
                    className: "btn btn-outline-primary",
                    messageTop: classInfo
                },
                {
                    extend: "excel",
                    className: "btn btn-outline-primary",
                    messageTop: classInfo
                },
                {
                    extend: "pdf",
                    className: "btn btn-outline-primary",
                    messageTop: classInfo
                },
                {
                    extend: "print",
                    className: "btn btn-outline-primary",
                    messageTop: "<h3>" + classInfo + "</h3>"
                }
            ]
        });

        // Initialize the progress bars
        $('.progress-bar').each(function() {
            const value = $(this).data('value');
            $(this).css('width', value + '%');
            
            if (value < 25) {
                $(this).addClass('bg-success');
            } else if (value < 50) {
                $(this).addClass('bg-info');
            } else if (value < 75) {
                $(this).addClass('bg-warning');
            } else {
                $(this).addClass('bg-danger');
            }
        });

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    </script>    <link rel="stylesheet" href="/nav.css">
    <link rel="stylesheet" href="/student-analysis.css">
    
    <style>
        :root {
            /* Primary (Sky Blue) Color Palette */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;  /* Main sky blue */
            --primary-600: #0284c7;  
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            /* Secondary (Brown) Color Palette */
            --secondary-50: #faf6f2;
            --secondary-100: #f2ebe1;
            --secondary-200: #e3d5c3;
            --secondary-300: #cfb99c;
            --secondary-400: #b99b76;
            --secondary-500: #a67c52; /* Main brown */
            --secondary-600: #8b5a2b;  
            --secondary-700: #6b4423;
            --secondary-800: #523319;
            --secondary-900: #3d2714;
            
            /* Simplified Variables */
            --primary: var(--primary-500);
            --primary-light: var(--primary-300);
            --primary-dark: var(--primary-700);
            --secondary: var(--secondary-600);
            --secondary-light: var(--secondary-500);
            --secondary-dark: var(--secondary-800);
            
            /* Other Colors */
            --light: #f8fafc;
            --dark: #1e293b;
            --accent: #a16207;  /* amber brown for accent */
            --accent-light: #ca8a04; /* lighter amber brown */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray: var(--gray-500);
            
            /* Status Colors */
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Elevation */
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            --card-hover-shadow: 0 12px 24px rgba(0, 0, 0, 0.14);
        }
        
        body {
            background-color: #f8fafc;
            font-family: 'Lexend', sans-serif;
            color: var(--dark);
            padding-bottom: 3rem;
            overflow-x: hidden;
        }
        
        /* Two-section layout styles */
        .analysis-container {
            position: relative;
            width: 100%;
            height: auto;
            margin-top: 20px;
        }
        
        .performance-section {
            width: 100%;
            overflow-y: auto;
            padding-right: 15px;
            padding-left: 15px;
            padding-bottom: 40vh; /* Extra space for the fixed PDF viewer */
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #f0f0f0;
        }
        
        /* Student performance section with extra margin */
        .student-performance-section {
            margin-bottom: 40vh; /* Ensure adequate space at the bottom for PDF viewer */
            padding-bottom: 30px;
        }
        
        /* Mobile PDF viewer enhancements */
        @media (max-width: 768px) {
            /* Add top margin so content starts below header */
            .wholecontainer {
                padding-top: 10px;
            }
            
            /* Paper toggle handle styling */
            .paper-toggle-handle {
                height: 6px;
                background-color: var(--primary);
                width: 60px;
                margin: 5px auto 10px auto;
                border-radius: 3px;
                cursor: pointer;
            }
            
            /* Collapsed state styling */
            .question-paper-section.collapsed {
                transform: translateY(calc(100% - 30px));
            }
            
            .question-paper-section.collapsed .paper-toggle-handle {
                margin-top: 10px;
                opacity: 1;
            }
            
            /* Fix PDF object height for mobile */
            .pdf-viewer-container object,
            .pdf-viewer-container embed,
            .pdf-viewer-container iframe {
                height: 22vh !important;
            }
            
            /* Question paper as true footer on mobile */
            .question-paper-section {
                height: 30vh;
                padding: 8px 15px;
                border-top-left-radius: 15px;
                border-top-right-radius: 15px;
            }
            
            /* Ensure content has room for the fixed footer */
            .performance-section {
                padding-bottom: 35vh;
            }
            
            .student-performance-section {
                margin-bottom: 35vh;
            }
        }
        
        /* Android WebView specific styles */
        .android-webview .question-paper-section {
            height: 30vh;
        }
        
        .android-webview .paper-toggle-handle {
            background-color: var(--primary);
            height: 6px;
            width: 80px;
        }
        
        .android-webview.is-mobile .pdf-container iframe {
            height: 200px !important;
        }
        
        /* Mobile Question Paper Button & Modal Styling */
        #mobilePdfButton {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1050;
          display: flex;
          flex-direction: column;
          align-items: center;
          width: auto;
        }
        
        #mobilePdfButton .btn {
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
          transition: transform 0.2s, box-shadow 0.2s;
          width: 65px;
          height: 65px;
          font-size: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
          border: 2px solid rgba(255, 255, 255, 0.8);
          animation: pulse 2s infinite;
          z-index: 1060; /* Ensure it stays on top of other elements */
        }
        
        #mobilePdfButton .btn:active {
          transform: scale(0.95);
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        #mobilePdfButton .btn-label {
          background-color: rgba(255, 255, 255, 0.9);
          color: var(--dark);
          padding: 2px 8px;
          border-radius: 12px;
          margin-top: 5px;
          font-weight: 500;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          font-size: 0.75rem;
        }
        
        /* Enhanced pulse animation for the button to make it more noticeable */
        @keyframes pulse {
          0% {
            box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.8);
            transform: scale(1);
          }
          50% {
            box-shadow: 0 0 0 12px rgba(37, 99, 235, 0);
            transform: scale(1.05);
          }
          100% {
            box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            transform: scale(1);
          }
          100% {
            box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
          }
        }
        
        .pulse-animation {
          animation: pulse 2s infinite;
        }
        
        /* Modal styling enhancements */
        #questionPaperModal .modal-content {
          border-radius: 12px;
          overflow: hidden;
        }
        
        #questionPaperModal .modal-header {
          padding: 0.75rem 1rem;
        }
        
        #questionPaperModal .pdf-loading {
          background-color: #f8f9fa;
          width: 100%;
          height: 100%;
        }
        
        #questionPaperModal .modal-content {
          border: none;
          border-radius: 12px;
          overflow: hidden;
        }
        
        #questionPaperModal .modal-header {
          background: linear-gradient(135deg, var(--primary) 0%, var(--secondary-dark) 100%);
          color: white;
          border-bottom: none;
        }
        
        #questionPaperModal .modal-footer {
          border-top: none;
          background: #f8f9fa;
        }
        
        #questionPaperModal .pdf-modal-container {
          background: #f5f5f5;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }
        
        .performance-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .performance-section::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        .performance-section::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 4px;
        }
        
        .question-paper-section {
            display: block; /* Always visible by default */
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: auto;
            max-height: 35vh; /* Reduced height to show more content */
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 90; /* Lower z-index so it doesn't overlap nav */
            transition: transform 0.3s ease-in-out, height 0.3s ease-in-out;
            transition: all 0.3s ease;
            background-image: linear-gradient(
                to bottom,
                var(--primary-50),
                white 120px
            );
            z-index: 99; /* Lower z-index to not interfere with nav */
        }
        
        .question-paper-section.sticky {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .sticky-paper {
            position: relative;
            padding-bottom: 20px;
        }
        
        .iframe-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--gray-100);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .iframe-loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            transition: opacity 0.3s ease;
            z-index: 5;
            color: var(--primary-600);
        }
        
        .pdf-container {
            position: relative;
            margin-top: 15px;
        }
        
        .pdf-container iframe {
            transition: height 0.3s ease;
            background-color: white;
            display: block;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        .iframe-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: 100%;
        }
        
        /* PDF zoom styling */
        #questionPaperIframe {
            transition: transform 0.3s ease;
            transform-origin: top center;
        }
        
        .zoom-controls .btn-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .zoom-controls .btn {
            border-radius: 0;
            padding: .375rem .5rem;
        }
        
        .zoom-controls .btn-outline-secondary:hover {
            background-color: var(--primary-100);
            color: var(--primary);
        }
        
        .zoom-controls .btn-outline-primary {
            border-color: var(--primary);
        }
        
        .pdf-controls {
            background-color: var(--light);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .paper-info {
            background-color: var(--primary-50);
            padding: 8px;
            border-radius: 4px;
        }
        
        /* PDF zoom styling */
        #questionPaperIframe {
            transition: transform 0.3s ease;
            transform-origin: top center;
        }
        
        .zoom-controls .btn-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .zoom-controls .btn {
            border-radius: 0;
            padding: .375rem .5rem;
        }
        
        .zoom-controls .btn-outline-secondary:hover {
            background-color: var(--primary-100);
            color: var(--primary);
        }
        
        .zoom-controls .btn-outline-primary {
            border-color: var(--primary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .analysis-container {
                padding-bottom: 40vh; /* Space for the fixed footer PDF viewer */
            }
            
            .performance-section {
                padding-right: 0;
                padding-left: 0;
                padding-bottom: 40vh;
                height: auto;
                max-height: none;
                overflow-y: visible;
            }
            
            .question-paper-section {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 95; /* Keep below nav/header */
                height: 35vh;
                max-height: 300px;
                margin: 0;
                padding: 10px;
                background: white;
                border-top: 3px solid var(--primary);
                border-radius: 15px 15px 0 0;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .sticky-paper {
                position: relative;
                height: 100%;
                padding-bottom: 0;
                overflow: hidden;
            }
            
            .pdf-container {
                height: calc(100% - 80px); /* Leave room for heading and controls */
                margin: 0;
            }
            
            .pdf-controls {
                padding: 5px;
                margin-top: 5px;
            }
            
            /* Hide some elements to save space */
            .paper-info, .zoom-controls .text-muted {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .question-paper-section {
                display: block;
                height: 30vh; /* Reduced height to show more content */
                padding: 10px;
                position: fixed !important;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 88; /* Lower z-index to not interfere with nav */
                background-color: white;
                border-radius: 15px 15px 0 0;
                box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.15);
                transition: transform 0.3s ease-in-out;
                transform: translateY(0);
            }
            
            .question-paper-section.collapsed {
                transform: translateY(calc(100% - 30px));
            }
            
            .question-paper-section.collapsed .paper-toggle-handle {
                opacity: 1;
            }
            
            .question-paper-section iframe,
            .question-paper-section object,
            .question-paper-section embed {
                height: 18vh !important; /* Reduced height for mobile PDF viewer */
            }
            
            .question-paper-section .pdf-controls {
                padding-bottom: env(safe-area-inset-bottom, 10px); /* Safe area for notch phones */
            }
            
            /* Handle to toggle PDF visibility on mobile */
            .paper-toggle-handle {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 5px;
                background-color: var(--gray-300);
                border-radius: 10px;
                margin-top: 5px;
            }
            
            /* Add padding to the bottom of the performance section to account for the fixed question paper */
            .performance-section {
                padding-bottom: 45vh; /* Increased padding to ensure content is visible above the PDF viewer */
            }
            
            /* Make bottom margin for the last card larger */
            .question-analysis-card:last-child {
                margin-bottom: 40vh; /* Increased margin to ensure the last card is fully visible */
            }
            
            /* Ensure the last item is visible */
            .student-performance-section .row:last-child {
                margin-bottom: 42vh; /* Additional margin for the very last element */
            }
            
            /* Smaller controls on mobile */
            .question-paper-section .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .performance-section {
                padding-top: 10px;
                padding-bottom: 300px; /* Space for the question paper at bottom */
            }
            
            .paper-toggle-handle {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 5px;
                background-color: var(--gray-300);
                border-radius: 10px;
                margin-top: 5px;
            }
            
            .row.g-0 {
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                padding-bottom: 20px;
                margin-bottom: 10px;
            }
            
            .row.g-0 .col {
                min-width: 250px;
                padding: 0 5px;
            }
            
            .scroll-indicator {
                display: block !important;
                opacity: 0.9;
            }
            
            .sticky-paper {
                padding-bottom: 5px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }
            
            .sticky-paper h4 {
                font-size: 1rem;
                margin-bottom: 5px;
                padding-bottom: 5px;
            }
            
            .pdf-container {
                margin: 5px 0;
                height: 180px;
            }
            
            .pdf-controls {
                padding: 5px;
            }
            
            .btn-group .btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .alert {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                font-size: 0.75rem;
            }
            
            /* Add toggle button */
            .paper-toggle {
                position: absolute;
                right: 10px;
                top: 10px;
                z-index: 1060;
                padding: 0.2rem 0.5rem;
                font-size: 0.75rem;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
        }
        
        /* Special layout for tablets in landscape mode */
        @media (min-width: 768px) and (max-width: 1200px) and (orientation: landscape) {
            .performance-section {
                padding-bottom: 30vh;
            }
            
            .question-paper-section {
                height: 30vh;
                max-height: 250px;
            }
            
            /* Larger controls for landscape mode */
            .question-paper-section .btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.9rem;
            }
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 80%);
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            color: white;
            padding-bottom: 1rem;
            position: relative;
            z-index: 1000; /* Ensure header stays above PDF viewer */
        }
        
        .hero-section {
            padding: 2rem 1rem;
            text-align: center;
        }
        
        #firstheading {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 0;
            color: white;
        }
        
        #firstspan {
            color: var(--accent);
            font-weight: 800;
        }
        
        .subheading {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.2rem;
        }
        
        .wholecontainer {
            display: none;
        }
        
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--primary);
        }
        
        .container-fluid {
            max-width: 1400px;
        }
        
        .info-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }
        
        .info-card h5 {
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 1.5rem;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-form {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .question-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-bottom: 3px solid var(--primary);
        }
        
        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .question-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .question-body {
            padding: 1.5rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
            font-weight: 600;
        }
        
        .see-students-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            text-decoration: none;
        }
        
        .see-students-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-correct {
            background: var(--success);
        }
        
        .btn-wrong {
            background: var(--error);
        }
        
        .btn-notattempt {
            background: var(--gray);
        }
        
        .btn-above50 {
            background: var(--primary);
        }
        
        .btn-below50 {
            background: var(--warning);
        }
        
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        
        .dataTables_wrapper .dt-buttons {
            margin-top: 1rem;
        }
        
        .dt-button {
            margin-right: 0.5rem;
        }
        
        .progress {
            height: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 1rem;
        }
        
        .breadcrumb {
            background-color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .table-responsive {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
        }
        
        #example_filter input {
            border-radius: 30px;
            padding: 0.375rem 1rem;
            border: 1px solid #e5e7eb;
        }
        
        #example_length select {
            border-radius: 30px;
            padding: 0.375rem 1rem;
            border: 1px solid #e5e7eb;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .hero-section {
                padding: 1.5rem 1rem;
            }
            
            #firstheading {
                font-size: 2rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .question-card {
                margin-bottom: 1rem;
            }
            
            /* Mobile responsive table */
            .totalMarksTable {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .totalMarksTable table {
                width: 100% !important;
                min-width: 300px;
            }
            
            /* Make container fluid truly responsive */
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Student performance section mobile adjustments */
            .page {
                flex-direction: column !important;
                margin-bottom: 2rem;
            }
            
            .parts {
                width: 100% !important;
                margin-bottom: 1rem;
            }
            
            .questionpart {
                width: 100% !important;
                height: auto !important;
                margin-top: 1rem;
            }
            
            .pdf-viewer-container {
                padding: 1rem !important;
                margin: 10px !important;
            }
            
            .pdf-viewer-container .btn {
                width: 100%;
                max-width: 250px;
            }
            
            /* Question analysis card mobile responsive */
            .question-analysis-card .row.g-0 {
                flex-direction: column;
            }
            
            .question-analysis-card .col {
                width: 100% !important;
                max-width: 100% !important;
                flex: none !important;
            }
            
            /* Column adjustments for mobile */
            .student-list-column {
                margin-bottom: 1rem;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            
            .column-body {
                max-height: 200px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Student item mobile styling */
            .student-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                background-color: #f8f9fa;
                border-radius: 4px;
                font-size: 0.85rem;
            }
            
            .student-name {
                flex: 1;
                margin-right: 0.5rem;
                font-weight: 500;
            }
            
            .student-marks {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.5rem !important;
            }
            
            /* PDF iframe mobile responsive */
            .questionpart iframe {
                width: 100% !important;
                height: 300px !important;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            
            /* Card header mobile adjustments */
            .card-header h5 {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .badge {
                font-size: 0.7rem;
                margin-top: 0.25rem;
                display: inline-block;
            }
            
            /* Info card mobile responsive */
            .info-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .info-card .row .col-md-6 {
                margin-bottom: 1rem;
            }
            
            /* Search form mobile adjustments */
            .search-form {
                padding: 1rem;
            }
            
            .search-form .row.g-3 .col-8,
            .search-form .row.g-3 .col-4 {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Extra small devices (phones, 576px and down) */
        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            
            #firstheading {
                font-size: 1.75rem;
            }
            
            .subheading {
                font-size: 1rem;
            }
            
            /* Smaller PDF viewer for very small screens */
            .question-paper-section {
                height: 40vh;
                max-height: 250px;
            }
            
            /* Larger toggle handle for better usability */
            .paper-toggle-handle {
                height: 7px;
                width: 70px;
                background-color: var(--primary);
                opacity: 0.9;
            }
            
            /* Add direct open button for PDFs that may not render */
            #pdfFallbackLinks {
                display: block !important;
            }
            
            /* Stack stats cards vertically on very small screens */
            .stats-card {
                margin-bottom: 0.75rem;
            }
            
            .stats-value {
                font-size: 1.5rem;
            }
            
            .stats-label {
                font-size: 0.8rem;
            }
            
            /* Question card title mobile */
            .card-header h5 {
                font-size: 0.9rem;
                text-align: left;
            }
            
            .badge {
                font-size: 0.65rem;
                display: block;
                margin-top: 0.5rem;
                margin-left: 0;
            }
            
            /* Column headers mobile */
            .column-header {
                font-size: 0.8rem;
                padding: 0.5rem !important;
            }
            
            .column-header i {
                display: none;
            }
            
            /* Breadcrumb mobile */
            .breadcrumb {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
            
            /* PDF iframe for very small screens */
            .questionpart iframe {
                height: 250px !important;
            }
            
            /* Button adjustments */
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* Landscape orientation adjustments for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .page {
                flex-direction: row !important;
            }
            
            .parts {
                width: 60% !important;
                margin-right: 1rem;
                margin-bottom: 0;
            }
            
            .questionpart {
                width: 38% !important;
                height: auto !important;
            }
            
            .pdf-viewer-container {
                padding: 0.5rem !important;
                margin: 5px !important;
            }
            
            .pdf-viewer-container .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .questionpart iframe {
                height: 400px !important;
            }
        }
        
        /* Custom scrollbar styles for better mobile experience */
        .column-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .column-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .column-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .column-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Touch-friendly scrolling for all scrollable areas */
        .column-body,
        .totalMarksTable,
        .table-responsive {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Student item styling for the analysis cards */
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .student-item:hover {
            background-color: #e9ecef;
            transform: translateX(4px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .student-item:last-child {
            margin-bottom: 0;
        }
        
        .student-name {
            flex: 1;
            margin-right: 0.5rem;
            font-weight: 500;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-marks {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            min-width: 40px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            letter-spacing: 0.5px;
        }
        
        /* Column styling for student performance cards */
        .student-list-column {
            background: white;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
            margin: 0 5px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            min-height: 150px;
        }
        
        /* Fix row and column layout in question cards */
        .question-analysis-card .row {
            display: flex;
            flex-wrap: nowrap;
            margin-right: -5px;
            margin-left: -5px;
            width: 100%;
            overflow-x: auto;
        }
        
        .question-analysis-card .col {
            flex: 0 0 260px;
            max-width: 260px;
            padding: 0 5px;
        }
        
        .column-header {
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .column-body {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            min-height: 150px;
            scrollbar-width: thin;
            scrollbar-color: var(--gray) #f0f0f0;
        }
        
        .column-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .column-body::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        
        .column-body::-webkit-scrollbar-thumb {
            background-color: var(--gray);
            border-radius: 3px;
        }
        
        /* Scroll indicator styling */
        .scroll-indicator {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            opacity: 0.8;
            transition: all 0.3s ease;
            z-index: 5;
        }
        
        .scroll-indicator:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        /* Color coding for different student performance levels */
        .correct-column .student-item {
            border-left-color: var(--success);
        }
        
        .incorrect-column .student-item {
            border-left-color: var(--error);
        }
        
        .fifty-column .student-item {
            border-left-color: var(--primary);
        }
        
        .below50-column .student-item {
            border-left-color: var(--warning);
        }
        
        /* Question analysis card styling */
        .question-analysis-card {
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background-color: white;
            width: 100%;
            clear: both;
            display: block;
            position: relative; /* Ensure proper stacking */
        }
        
        .question-analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }
        
        /* Priority indicators for question cards based on wrong answers */
        .question-analysis-card.high-priority {
            border-left: 5px solid var(--error);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.18);
        }
        
        .question-analysis-card.medium-priority {
            border-left: 5px solid var(--warning);
            box-shadow: 0 8px 16px rgba(245, 158, 11, 0.18);
        }
        
        .question-analysis-card.low-priority {
            border-left: 5px solid var(--success);
            box-shadow: 0 8px 16px rgba(34, 197, 94, 0.18);
        }
        
        .question-analysis-card .card-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Header indicators */
        .priority-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.5px;
        }
        
        /* PDF container styling */
        .pdf-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
        }
        
        .pdf-container iframe, 
        .pdf-container object,
        .pdf-container embed {
            border: none;
            width: 100%;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .pdf-viewer-container {
            position: relative;
            min-height: 200px;
        }
        
        .pdf-blocked-message {
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            background-color: rgba(255, 248, 230, 0.9);
        }
        
        /* Browser-specific adjustments */
        .browser-edge .pdf-viewer-container object,
        .browser-edge .pdf-viewer-container embed {
            min-height: 300px;
        }
        
        /* Handle Microsoft Edge's PDF rendering peculiarities */
        @supports (-ms-ime-align:auto) {
            .pdf-viewer-container {
                position: relative;
                overflow: hidden;
            }
            
            .pdf-viewer-container::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255,255,255,0.01); /* Transparent overlay to capture clicks */
                z-index: 1;
            }
        }
        
        .sticky-paper h4 {
            color: var(--primary-dark);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .sticky-paper .alert {
            border-radius: 10px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .sticky-paper .btn {
            border-radius: 30px;
            padding: 8px 20px;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .sticky-paper .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .priority-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        .priority-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .priority-low {
            background-color: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        
        /* Two-column layout additional styles */
        .card.question-analysis-card {
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .card.question-analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Improved scrollbars */
        .performance-section::-webkit-scrollbar {
            width: 10px;
        }
        
        .performance-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .performance-section::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .performance-section::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Question paper section styles */
        .question-paper-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35vh;
            background: white;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 15px 15px 0 0;
            z-index: 95;
            transition: all 0.3s ease;
            padding: 10px 15px;
        }
        
        .sticky-paper {
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            height: calc(100% - 20px);
        }
        
        .question-paper-section h4 {
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .pdf-container {
            overflow: hidden;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Fix for navigation and last card visibility issues */
        header, nav, .sidenav {
            z-index: 100001 !important; /* Ensure navigation stays on top */
            position: relative;
        }
        
        /* Ensure proper spacing at the bottom of the content */
        .student-performance-section {
            padding-bottom: 50px;
            margin-bottom: 45vh; /* Large margin to account for fixed PDF viewer */
        }
        
        /* Create a bit more space between the last card and the PDF viewer */
        #performanceSection {
            padding-bottom: 50vh !important; /* Ensure this overrides other padding settings */
        }
        
        /* Reduce height of PDF viewer to show more content */
        .pdf-viewer-container {
            max-height: 35vh;
        }
        
        /* Styles to ensure the breadcrumb navigation is visible */
        .breadcrumb {
            position: relative;
            z-index: 1000; /* Ensure navigation stays above PDF viewer */
        }
        
        /* Additional mobile responsiveness for question paper */
        .is-mobile .question-paper-section {
            transition: transform 0.3s ease-in-out, height 0.3s ease-in-out;
        }
        
        .is-mobile .question-paper-section.collapsed {
            transform: translateY(calc(100% - 30px));
        }
        
        /* Improve readability on mobile devices */
        @media (max-width: 480px) {
            .is-mobile .card-header h5 {
                font-size: 0.9rem;
            }
            
            .is-mobile .question-paper-section .pdf-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .is-mobile .sticky-paper {
                padding: 10px 5px;
            }
            
            /* Better touch target sizes */
            .is-mobile .btn-sm {
                padding: 8px 12px;
                margin: 5px;
            }
        }
    </style>
</head>
<body>
       <%- include('partials/sidenav', { 
        subjects: subjects, 
        studentClassdata: studentClassdata,
        terminals: terminals 
    }) %>
    <div class="loader">
        <script src="https://cdn.lordicon.com/lordicon.js"></script>
        <lord-icon
            src="https://cdn.lordicon.com/lqxfrxad.json"
            trigger="loop"
            state="loop-scale"
            colors="primary:#0ea5e9,secondary:#8b5a2b"
            style="width:100px;height:100px;">
        </lord-icon>
    <script>
  let textArray = [
    "Generating Analysis...",
    "Ah, I got the data...",
    "Thinking....",
    "Let me analyze it...",
    "Almost there...",
    "Just a moment...",
    "Thank you for waiting...",
    "Something best is coming..."
  ];

  textArray.forEach((text, index) => {
    setTimeout(() => {
      document.getElementById('loadtext').innerHTML = text;
    }, index * 900); // each one shows after 1.5s delay
  });
</script>

<div class="mt-3" id="loadtext"></div>

    </div>
    
    <div class="wholecontainer">
        <header>
            <%- include('./partials/nav',{currentPage:'teacher'}) %>
            <div class="hero-section">
                <h1 id="firstheading">Class <span id="firstspan">Performance</span></h1>
                <span class="subheading">Comprehensive analysis and evaluation of student responses</span>
            </div>
        </header>
        
        <!-- Mobile-specific question paper button that appears fixed at bottom center -->
        <div class="d-block d-md-none" id="mobilePdfButton">
          <button class="btn btn-primary rounded-circle shadow pulse-animation" id="openQuestionPaperBtn" 
            aria-label="Open Question Paper" title="Open Question Paper in New Tab">
            <i class="fa-solid fa-external-link-alt" style="color: #ffffff;"></i>
          </button>
          <span class="btn-label small">View Paper</span>
        </div>
        
        <!-- Modal for displaying question paper on mobile without page reload -->
        <div class="modal fade" id="questionPaperModal" tabindex="-1" aria-labelledby="questionPaperModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary-dark) 100%); color: white;">
                <h5 class="modal-title" id="questionPaperModalLabel">
                  <i class="fas fa-file-alt me-2"></i>Question Paper
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0 position-relative">
                <div class="pdf-modal-container h-100 d-flex flex-column justify-content-center align-items-center">
                  <!-- Loading spinner is added here initially -->
                  <div class="d-flex flex-column justify-content-center align-items-center h-100 pdf-loading" id="modalPdfLoadingIndicator">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading question paper...</div>
                  </div>
                  
                  <!-- Button to load PDF using our custom PDF.js viewer -->
                  <div class="text-center my-4" id="modalPdfViewerControls">
                    <button id="loadModalPdf" class="btn btn-primary">
                      <i class="fas fa-file-pdf me-2"></i> Load Question Paper
                    </button>
                    <p class="text-muted small mt-2">Click to view the PDF with page navigation</p>
                  </div>
                  
                  <!-- PDF will be loaded here via JavaScript -->
                  <div id="modalPdfContainer" style="width: 100%; height: 100%; min-height: 75vh;"></div>
                  
                  <!-- PDF.js viewer link -->
                  <div class="text-center mt-3" id="pdfJsViewerLink" style="display: none;">
                    <a href="/web/viewer.html?file=/uploads/<%=file%>" target="_blank" class="btn btn-outline-primary">
                      <i class="fas fa-external-link-alt me-1"></i> Open in PDF.js Viewer
                    </a>
                    <p class="text-muted small mt-2">For best experience with navigation between pages</p>
                  </div>
                </div>
              </div>
              <div class="modal-footer d-flex justify-content-between" style="background-color: #f8f9fa;">
                <span class="text-muted small d-none d-sm-block"><%= file %></span>
                <div>
                  <a href="/uploads/<%=file%>" class="btn btn-outline-primary" download>
                    <i class="fas fa-download me-1"></i> Download
                  </a>
                  <button id="openPdfJsViewer" class="btn btn-primary mx-2">
                    <i class="fas fa-external-link-alt me-1"></i> Open in PDF.js
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

    



       


        <div class="container-fluid">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/forms" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a href="/teacher/<%= subjectname %>/findData" class="text-decoration-none"><%= subjectname %></a></li>
                    <li class="breadcrumb-item">Class <%= studentClass %> (<%= section %>)</li>
                    <li class="breadcrumb-item active" aria-current="page"><%= terminal %> Terminal</li>
                </ol>
            </nav>
            
            <!-- Overview Section -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="info-card mb-4">
                        <h5><i class="fas fa-chart-line me-2"></i>Performance Summary</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Subject:</strong> <%= subjectname %>
                                </p>
                                <p class="mb-2">
                                    <strong>Class:</strong> <%= studentClass %> (<%= section %>)
                                </p>
                                <p class="mb-2">
                                    <strong>Terminal:</strong> <%= terminal %>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Total Students:</strong> <%= totalStudent %>
                                </p>
                                <p class="mb-2">
                                    <strong>Date Generated:</strong> <%= new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) %>
                                </p>
                                <p class="mb-0">
                                    <a href="/totalStudent/<%= subjectname %>/<%= studentClass %>/<%= section %>/<%= terminal %>" class="btn btn-sm" style="background-color: var(--primary); color: white;">
                                        <i class="fas fa-users me-1"></i> View All Students
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <% if (results.length > 0) { %>
                        <div class="info-card">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Key Insights</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-warning mb-3">
                                        <h6 class="alert-heading mb-2">Most Challenging Question</h6>
                                        <p class="mb-1"><strong><%= results[0].questionNo %></strong> was answered incorrectly by <strong><%= results[0].wrong %></strong> students</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-danger" style="width: <%= (results[0].wrong/totalStudent*100).toFixed(1) %>%"></div>
                                        </div>
                                        <small class="text-muted"><%= (results[0].wrong/totalStudent*100).toFixed(1) %>% failure rate</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <% if (results.length > 1) { %>
                                        <div class="alert alert-info mb-3">
                                            <h6 class="alert-heading mb-2">Second Most Challenging</h6>
                                            <p class="mb-1"><strong><%= results[1].questionNo %></strong> was answered incorrectly by <strong><%= results[1].wrong %></strong> students</p>
                                            <div class="progress">
                                                <div class="progress-bar bg-warning" style="width: <%= (results[1].wrong/totalStudent*100).toFixed(1) %>%"></div>
                                            </div>
                                            <small class="text-muted"><%= (results[1].wrong/totalStudent*100).toFixed(1) %>% failure rate</small>
                                        </div>
                                    <% } else { %>
                                        <div class="alert alert-success mb-3">
                                            <h6 class="alert-heading mb-2">Looking Good!</h6>
                                            <p class="mb-0">Overall performance looks promising based on available data.</p>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    
                </div>
                <div class="col-lg-4">
                    <div class="row">
                        <div class="col-6">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stats-value"><%= totalStudent %></div>
                                <div class="stats-label">Total Students</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="stats-value"><%= results.length %></div>
                                <div class="stats-label">Total Questions</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="search-form">
                                <h5 class="mb-3"><i class="fas fa-search me-2"></i>Student Search</h5>
                                <form action="/search/<%= subjectname %>/<%= studentClass %>/<%= section %>/<%= terminal %>" method="POST" class="row g-3">
                                    <div class="col-8">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                            <input type="number" class="form-control" id="searchroll" name="roll" placeholder="Enter Roll Number" required>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <button type="submit" class="btn w-100" style="background-color: var(--secondary); color: white;">
                                            <i class="fas fa-search me-1"></i> Find
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- DataTable -->
            <div class="row mb-4" id="analysisTable">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-3" style="background-color: var(--primary); color: white;">
                            <h5 class="mb-0">

       

                        <select name="class" id="classSelect">
  <option value="" selected disabled>-Select Class-</option>

  <% 
    const sortedClasslist = [...classlistData].sort((a, b) => Number(a) - Number(b));  %>
 

  <% sortedClasslist.forEach(classItem => { %>
    <option value="<%= classItem %>">
      <%= classItem %>
    </option>
  <% }) %>
</select>

                                <select name="section" id="sectionSelect">
                                    <option value="" selected disabled>-Select Section-</option>
                                    <% classlistData.forEach(function(sectionItem) { %>
                                        <option value="<%= sectionItem %>"><%= sectionItem %></option>
                                    <% }); %>
                                </select>
                                
                              <button onclick="analysis('<%= subjectname %>', '<%= terminal %>')">Find</button>

                                <i class="fas fa-table me-2"></i> Question Analysis Table
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="example" class="table table-striped table-hover" style="width:100%">
                                    <!-- DataTables will populate this -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<!-- Create a mapping of questions to group all categories by question number -->
<% 
  // Create a map to store question data grouped by question number
  const questionMap = new Map();

  // Helper function to add data to the question map
  function addToQuestionMap(questionNo, categoryName, data) {
    if (!questionMap.has(questionNo)) {
      questionMap.set(questionNo, {
        questionNo: questionNo,
        fullMarks: data.fullMarks,
        categories: {}
      });
    }
    
    questionMap.get(questionNo).categories[categoryName] = {
      total: data.total,
      studentName: data.studentName,
      obtainedMarks: data.obtainedMarks
    };
  }

  // Add all categories to the map
  Correct.forEach(student => {
    addToQuestionMap(student.qno, 'correct', student);
  });
  
  inCorrect.forEach(student => {
    addToQuestionMap(student.qno, 'incorrect', student);
  });
  
  fifty.forEach(student => {
    addToQuestionMap(student.qno, 'fifty', student);
  });
  
  CorrectBelow50.forEach(student => {
    addToQuestionMap(student.qno, 'correctBelow50', student);
  });
  
  CorrectAbove50.forEach(student => {
    addToQuestionMap(student.qno, 'correctAbove50', student);
  });
  
  // Sort the questions by question number, but prioritize by wrong count (most wrong first)
  const sortedQuestionData = Array.from(questionMap.values()).sort((a, b) => {
    // First sort by most incorrect students (descending)
    const aIncorrect = a.categories.incorrect ? a.categories.incorrect.total : 0;
    const bIncorrect = b.categories.incorrect ? b.categories.incorrect.total : 0;
    
    if (aIncorrect !== bIncorrect) {
      return bIncorrect - aIncorrect; // Most wrong first
    }
    
    // If same incorrect count, sort by question number
    return a.questionNo.localeCompare(b.questionNo, undefined, { numeric: true });
  });
%>

<!-- Student Performance Data - Two-section Layout -->
<div class="student-performance-section mt-5 mb-4">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="section-header text-center mb-4">
          <h4 class="fw-bold"><i class="fas fa-chart-bar me-2"></i>Student Response Analysis by Question</h4>
          <p class="text-muted">Detailed breakdown of student performance grouped by question with question paper always visible</p>
        
        </div>
      </div>
    </div>
    
    <!-- Main content container -->
    <div class="analysis-container">
      <!-- Scrollable performance cards -->
      <div class="performance-section" id="performanceSection">
        <!-- Performance cards render directly here -->
        <% sortedQuestionData.forEach(questionData => { 
          const incorrectCount = questionData.categories.incorrect ? questionData.categories.incorrect.total : 0;
          const totalStudents = totalStudent;
          const wrongPercentage = totalStudents > 0 ? (incorrectCount / totalStudents) * 100 : 0;
          
          // Determine priority based on wrong percentage
          let priorityClass = 'low-priority';
          let priorityLabel = 'Good Performance';
          let priorityIndicator = 'priority-low';
          
          if (wrongPercentage >= 50) {
            priorityClass = 'high-priority';
            priorityLabel = 'Needs Attention';
            priorityIndicator = 'priority-high';
          } else if (wrongPercentage >= 30) {
            priorityClass = 'medium-priority';
            priorityLabel = 'Monitor Progress';
            priorityIndicator = 'priority-medium';
          }
        %>

        <div class="card mb-4 question-analysis-card <%= priorityClass %>">
          <div class="card-header py-3 text-center" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary-dark) 100%); color: white;">
            <h5 class="mb-0">
              <i class="fas fa-clipboard-check me-2"></i> Question <%= questionData.questionNo %>
              <span class="badge bg-light text-dark ms-2">Full Marks: <%= questionData.fullMarks %></span>
              <span class="priority-indicator <%= priorityIndicator %>"><%= priorityLabel %></span>
            </h5>
            <small class="d-block mt-2">Wrong: <%= incorrectCount %> students (<%= wrongPercentage.toFixed(1) %>%)</small>
          </div>
          
          <div class="card-body p-0">
            <div class="question-row" style="display: flex; flex-wrap: nowrap; overflow-x: auto; padding: 0.5rem; position: relative; gap: 10px; scroll-behavior: smooth; min-height: 200px;">
              <div class="scroll-indicator" style="position: absolute; bottom: 5px; right: 10px; background: rgba(0,0,0,0.1); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; opacity: 0.7;">
                <i class="fas fa-arrows-alt-h"></i> Scroll
              </div>
              <!-- Column 1: Correct Answers -->
              <div class="question-column" style="flex: 0 0 260px; padding: 0 5px; max-width: 260px;">
                <div class="student-list-column correct-column h-100">
                  <div class="column-header bg-success text-white p-2">
                    <i class="fas fa-check-circle me-1"></i> Correct
                    <span class="badge bg-light text-dark float-end">
                      <%= questionData.categories.correct ? questionData.categories.correct.total : 0 %>
                    </span>
                  </div>
                  <div class="column-body p-3">
                    <% if (questionData.categories.correct) { %>
                      <% questionData.categories.correct.studentName.forEach((name, idx) => { %>
                        <div class="student-item">
                          <span class="student-name"><%= name %></span>
                          <span class="student-marks badge bg-light text-success">
                            <%= questionData.categories.correct.obtainedMarks[idx] %>
                          </span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="text-muted text-center py-3">No students in this category</div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Column 2: Incorrect Answers -->
              <div class="question-column" style="flex: 0 0 260px; padding: 0 5px; max-width: 260px;">
                <div class="student-list-column incorrect-column h-100">
                  <div class="column-header bg-danger text-white p-2">
                    <i class="fas fa-times-circle me-1"></i> Incorrect
                    <span class="badge bg-light text-dark float-end">
                      <%= questionData.categories.incorrect ? questionData.categories.incorrect.total : 0 %>
                    </span>
                  </div>
                  <div class="column-body p-3">
                    <% if (questionData.categories.incorrect) { %>
                      <% questionData.categories.incorrect.studentName.forEach((name, idx) => { %>
                        <div class="student-item">
                          <span class="student-name"><%= name %></span>
                          <span class="student-marks badge bg-light text-danger">
                            <%= questionData.categories.incorrect.obtainedMarks[idx] %>
                          </span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="text-muted text-center py-3">No students in this category</div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Column 3: 50% Correct -->
              <div class="question-column" style="flex: 0 0 260px; padding: 0 5px; max-width: 260px;">
                <div class="student-list-column fifty-column h-100">
                  <div class="column-header bg-primary text-white p-2">
                    <i class="fas fa-percentage me-1"></i> 50% Correct
                    <span class="badge bg-light text-dark float-end">
                      <%= questionData.categories.fifty ? questionData.categories.fifty.total : 0 %>
                    </span>  
                  </div>
                  <div class="column-body p-3">
                    <% if (questionData.categories.fifty) { %>
                      <% questionData.categories.fifty.studentName.forEach((name, idx) => { %>
                        <div class="student-item">
                          <span class="student-name"><%= name %></span>
                          <span class="student-marks badge bg-light text-primary">
                            <%= questionData.categories.fifty.obtainedMarks[idx] %>
                          </span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="text-muted text-center py-3">No students in this category</div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Column 4: Below 50% Correct -->
              <div class="question-column" style="flex: 0 0 260px; padding: 0 5px; max-width: 260px;">
                <div class="student-list-column below50-column h-100">
                  <div class="column-header bg-warning text-dark p-2">
                    <i class="fas fa-arrow-down me-1"></i> Below 50%
                    <span class="badge bg-light text-dark float-end">
                      <%= questionData.categories.correctBelow50 ? questionData.categories.correctBelow50.total : 0 %>
                    </span>
                  </div>
                  <div class="column-body p-3">
                    <% if (questionData.categories.correctBelow50) { %>
                      <% questionData.categories.correctBelow50.studentName.forEach((name, idx) => { %>
                        <div class="student-item">
                          <span class="student-name"><%= name %></span>
                          <span class="student-marks badge bg-light text-warning">
                            <%= questionData.categories.correctBelow50.obtainedMarks[idx] %>
                          </span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="text-muted text-center py-3">No students in this category</div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- Column 5: Above 50% -->
              <div class="question-column" style="flex: 0 0 260px; padding: 0 5px; max-width: 260px;">
                <div class="student-list-column above50-column h-100">
                  <div class="column-header bg-success text-white p-2">
                    <i class="fas fa-arrow-up me-1"></i> Above 50%
                    <span class="badge bg-light text-dark float-end">
                      <%= questionData.categories.correctAbove50 ? questionData.categories.correctAbove50.total : 0 %>
                    </span>
                  </div>
                  <div class="column-body p-3">
                    <% if (questionData.categories.correctAbove50) { %>
                      <% questionData.categories.correctAbove50.studentName.forEach((name, idx) => { %>
                        <div class="student-item">
                          <span class="student-name"><%= name %></span>
                          <span class="student-marks badge bg-light text-warning">
                            <%= questionData.categories.correctAbove50.obtainedMarks[idx] %>
                          </span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="text-muted text-center py-3">No students in this category</div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>
  </div>
</div>

<!-- Floating Question Paper Button (Desktop Only) -->
<div class="pdf-button-container d-none d-md-block" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
  <button id="openQuestionPaperBtn" class="btn btn-primary rounded-circle" style="
    width: 60px; 
    height: 60px; 
    box-shadow: 0 2px 15px rgba(13, 110, 253, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    animation: glowing 1.5s infinite alternate;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  " onclick="window.open('/uploads/<%= file %>', '_blank')">
    <i class="fas fa-file-alt" style="font-size: 1.5rem;"></i>
  </button>
  <div style="text-align: center; margin-top: 5px; font-size: 0.8rem; color: #666;">
    Open Question Paper
  </div>
</div>

<style>
@keyframes glowing {
  from {
    box-shadow: 0 0 5px #0d6efd,
                0 0 10px #0d6efd,
                0 0 15px #0d6efd;
  }
  to {
    box-shadow: 0 0 10px #0d6efd,
                0 0 20px #0d6efd,
                0 0 30px #0d6efd;
  }
}
</style>

<!-- Question Paper Modal -->
<div class="modal fade" id="questionPaperModal" tabindex="-1" aria-labelledby="questionPaperModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="questionPaperModalLabel"><i class="fas fa-file-alt me-2"></i>Question Paper</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="pdf-container" style="height: 80vh;">
    
    <% if (fileStatus === 'missing') { %>
      <div class="alert alert-warning mb-2">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Question paper is not available
      </div>
    <% } else if (fileStatus === 'default') { %>
      <div class="alert alert-info mb-2">
        <i class="fas fa-info-circle me-2"></i>
        Using default template
      </div>
    <% } %>
    
    <div class="pdf-container">        <div class="iframe-wrapper">
          <div class="iframe-loading-indicator" id="pdfLoadingIndicator">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading question paper...</div>
          </div>
          
          <!-- PDF viewer with multiple fallbacks -->
          <div id="pdfViewerContainer" class="pdf-viewer-container">
            <!-- Enhanced PDF support messaging -->
            <div id="pdfSupportMessage" class="alert alert-warning mb-3" style="display: none;">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span><strong>PDF Viewer Not Available</strong> - Your browser may not support embedded PDFs.</span>
              </div>
            </div>
            
            <!-- Browser detection for Android WebView -->
            <div class="android-webview-only alert alert-info mb-3" style="display: none;">
              <i class="fas fa-info-circle me-2"></i>
              <span>For best experience, tap the button below to view the question paper.</span>
            </div>
            
            <!-- Placeholder for PDF that will be loaded only when needed -->
            <div 
              id="questionPaperObject"
              data-pdf-url="/uploads/<%=file%>#toolbar=0&navpanes=0&view=FitH&embedded=true"
              style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; 
                     min-height: 25vh; background-color: #f8f9fa; display: flex; align-items: center; 
                     justify-content: center; flex-direction: column;"
              class="pdf-viewer-placeholder">
              
              <i class="fas fa-file-pdf fa-3x mb-3" style="color: #dc3545;"></i>
              <h5>Question Paper PDF</h5>
              <p class="text-muted">Click the button below to load the question paper</p>
              <button onclick="loadQuestionPaper()" class="btn btn-primary mt-2">
                <i class="fas fa-file-pdf me-2"></i> Load Question Paper
              </button>
                
                <!-- Enhanced fallback message with clear instructions and styling -->
                <div class="pdf-blocked-message p-4 text-center">
                  <div class="mb-3">
                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                    <h5>PDF Preview Not Available</h5>
                    <p class="mb-1">Your browser doesn't support embedded PDF viewing.</p>
                    <p class="text-muted small">Please use one of the options below:</p>
                  </div>
                </div>
            </div>
          </div>
          
          <!-- Enhanced buttons with clear options for users -->
          <div class="text-center mt-3 mb-2" id="pdfFallbackLinks">
            <div class="pdf-action-buttons">
              <a href="/uploads/<%=file%>" target="_blank" class="btn btn-sm btn-primary me-2" 
                onclick="event.preventDefault(); window.open(this.href, '_blank', 'toolbar=0,location=0,menubar=0');">
                <i class="fas fa-external-link-alt me-1"></i> Open in New Tab
              </a>
              <a href="/uploads/<%=file%>" download class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Download PDF
              </a>
              <button type="button" class="btn btn-sm btn-outline-info android-webview-only ms-2" style="display: none;" id="useGoogleViewer">
                <i class="fab fa-google me-1"></i> Try Google Viewer
              </button>
            </div>
            <div class="mt-2 small text-muted" id="pdfSupportNotice">
              <i class="fas fa-info-circle me-1"></i> 
              If you can't see the PDF above, please use these buttons
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="pdf-controls mt-2">
      <div class="row">
        <div class="col">
          <div class="zoom-controls d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small"><i class="fas fa-search"></i> Zoom</span>
            <div class="btn-group">
              <button id="zoomOut" type="button" class="btn btn-sm btn-outline-secondary" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
              </button>
              <button id="resetZoom" type="button" class="btn btn-sm btn-outline-primary" title="Reset Zoom">
                <i class="fas fa-redo-alt"></i>
              </button>
              <button id="zoomIn" type="button" class="btn btn-sm btn-outline-secondary" title="Zoom In">
                <i class="fas fa-search-plus"></i>
              </button>
              <!-- Extra buttons removed -->
                  </div>
                </div>
              </div>
            </div>
            
            <a href="/uploads/<%=file%>#toolbar=0&navpanes=0&view=FitH" target="_blank" class="btn btn-primary w-100 mt-2" 
              onclick="event.preventDefault(); window.open(this.href, '_blank', 'toolbar=0,location=0,menubar=0');">
              <i class="fas fa-external-link-alt me-2"></i>
              View Fullscreen
            </a>
            
            <div class="mt-3 text-center text-muted small d-none d-md-block paper-info">
              <i class="fas fa-thumbtack me-1"></i> 
              Question paper stays visible while scrolling
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create a mapping of questions to group all categories by question number -->
<script>
  // Function to lazily load the PDF when requested
  function loadQuestionPaper() {
    const placeholder = document.getElementById('questionPaperObject');
    if (!placeholder) return;
    
    const pdfUrl = placeholder.getAttribute('data-pdf-url');
    if (!pdfUrl) return;
    
    // Show loading indicator
    const loadingIndicator = document.getElementById('pdfLoadingIndicator');
    if (loadingIndicator) {
      loadingIndicator.style.display = 'block';
    }
    
    // For better compatibility and to prevent auto-downloads, use PDF.js viewer instead
    const isWebView = isAndroidWebView();
    if (isWebView || !supportsPdfEmbedding()) {
      // Use PDF.js viewer for WebView or browsers without PDF support
      const timestamp = new Date().getTime();
      const pdfJsViewerUrl = `/web/viewer.html?file=${encodeURIComponent('/uploads/' + '<%= file %>')}&t=${timestamp}`;
      
      // Use button to open PDF.js in new tab
      const pdfJsButton = document.createElement('div');
      pdfJsButton.className = 'text-center my-4';
      pdfJsButton.innerHTML = `
        <button class="btn btn-primary" onclick="window.open('${pdfJsViewerUrl}', '_blank')">
          <i class="fas fa-file-pdf me-2"></i> Open PDF with Navigation
        </button>
        <p class="text-muted small mt-2">Opens in a new tab with full page navigation</p>
      `;
      
      placeholder.innerHTML = '';
      placeholder.appendChild(pdfJsButton);
      
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      return;
    }
    
    // For browsers that support PDF embedding
    // Create object element
    const pdfObject = document.createElement('object');
    pdfObject.setAttribute('data', pdfUrl);
    pdfObject.setAttribute('type', 'application/pdf');
    pdfObject.setAttribute('width', '100%');
    pdfObject.setAttribute('height', '25vh');
    pdfObject.setAttribute('id', 'questionPaperViewer');
    pdfObject.setAttribute('class', 'pdf-viewer');
    pdfObject.style.borderRadius = '8px';
    pdfObject.style.boxShadow = '0 4px 8px rgba(0,0,0,0.05)';
    pdfObject.style.transition = 'all 0.3s ease';
    
    // Add event listener to hide loading indicator when PDF loads
    pdfObject.addEventListener('load', function() {
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    });
    
    // Create fallback content for browsers that don't support PDFs
    const fallbackDiv = document.createElement('div');
    fallbackDiv.className = 'pdf-blocked-message p-4 text-center';
    fallbackDiv.innerHTML = `
      <div class="mb-3">
        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
        <h5>PDF Preview Not Available</h5>
        <p class="mb-1">Your browser doesn't support embedded PDF viewing.</p>
        <p class="text-muted small">Please use one of the options below:</p>
      </div>
      <a href="/uploads/<%=file%>" target="_blank" class="btn btn-primary mb-2">
        <i class="fas fa-external-link-alt me-1"></i> Open PDF in New Tab
      </a>
      <a href="/uploads/<%=file%>" download class="btn btn-outline-primary">
        <i class="fas fa-download me-1"></i> Download PDF
      </a>
    `;
    
    pdfObject.appendChild(fallbackDiv);
    
    // Replace the placeholder with the PDF object
    placeholder.parentNode.replaceChild(pdfObject, placeholder);
  }
  
  // JavaScript to ensure both sections are sized correctly and handle zoom functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Special handling for Android WebView
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isWebView = /wv|WebView/i.test(navigator.userAgent);
    
    if (isAndroid && isWebView) {
      console.log("Android WebView detected");
      document.body.classList.add('android-webview');
      
      // Find PDF container and replace with iframe
      const pdfObject = document.querySelector('#questionPaperObject');
      if (pdfObject) {
        const pdfSrc = pdfObject.getAttribute('data') || "";
        const iframe = document.createElement('iframe');
        iframe.src = pdfSrc;
        iframe.style.width = "100%";
        iframe.style.height = "200px";
        iframe.className = "pdf-viewer";
        pdfObject.parentNode.replaceChild(iframe, pdfObject);
      }
    }
    
    // Detect browser and device type for specific handling
    function detectBrowser() {
      const userAgent = navigator.userAgent;
      let browserName;
      
      if (userAgent.match(/edg/i)) {
        browserName = "edge";
      } else if (userAgent.match(/chrome|chromium|crios/i)) {
        browserName = "chrome";
      } else if (userAgent.match(/firefox|fxios/i)) {
        browserName = "firefox";
      } else if (userAgent.match(/safari/i)) {
        browserName = "safari";
      } else if (userAgent.match(/opr\//i)) {
        browserName = "opera";
      } else if (userAgent.match(/android/i)) {
        browserName = "android";
      } else {
        browserName = "unknown";
      }
      
      // Check if it's WebView
      if (/wv/.test(userAgent)) {
        browserName += "-webview";
      }
      
      // Check if it's mobile
      if (/Mobi|Android/i.test(userAgent)) {
        document.body.classList.add('is-mobile');
      }
      
      return browserName;
    }
    
    // Apply browser-specific optimizations
    const browser = detectBrowser();
    document.body.classList.add(`browser-${browser}`);
    
    // For Edge browser or WebView, use different PDF rendering approach
    if (browser === 'edge' || browser.includes('webview')) {
      console.log('Microsoft Edge or WebView detected - applying PDF optimizations');
      // Add data attributes for special handling
      const pdfObject = document.getElementById('questionPaperObject');
      if (pdfObject) {
        pdfObject.setAttribute('data-browser', browser);
      }
    }
    
    // Always show the question paper at the bottom
    const questionPaperSection = document.getElementById('questionPaperSection');
    if (questionPaperSection) {
      questionPaperSection.classList.add('sticky');
      
      // On mobile, initially show collapsed
      if (window.innerWidth <= 768) {
        questionPaperSection.classList.add('collapsed');
        
        // Add click handler for the toggle handle
        const toggleHandle = questionPaperSection.querySelector('.paper-toggle-handle');
        if (toggleHandle) {
          toggleHandle.addEventListener('click', function() {
            questionPaperSection.classList.toggle('collapsed');
          });
        }
      }
    }
    
    // Set initial heights for scrollable content
    adjustHeights();
    
    // Re-adjust on window resize
    window.addEventListener('resize', adjustHeights);
    
    // Handle mobile view
    setupMobileLayout();
    
    // Initialize zoom functionality
    initZoom();
    
    // Enhanced PDF support detection and handling
    const pdfObject = document.getElementById('questionPaperObject');
    const loadingIndicator = document.getElementById('pdfLoadingIndicator');
    const pdfSupportMessage = document.getElementById('pdfSupportMessage');
    const pdfFallbackLinks = document.getElementById('pdfFallbackLinks');
    const useGoogleViewerBtn = document.getElementById('useGoogleViewer');
    
    // Function to check if browser is likely to support PDF viewing
    function checkPDFSupport() {
      const ua = navigator.userAgent.toLowerCase();
      // Check browser types that typically support PDFs
      const isChrome = ua.indexOf('chrome') > -1 && ua.indexOf('edge') === -1;
      const isFirefox = ua.indexOf('firefox') > -1;
      const isSafari = ua.indexOf('safari') > -1 && ua.indexOf('chrome') === -1;
      const isEdge = ua.indexOf('edg') > -1;
      
      // iOS and macOS Safari have good PDF support
      const isApple = /ipad|iphone|ipod|macintosh/.test(ua) && !window.MSStream;
      
      // WebViews often have issues with PDFs
      const isWebView = ua.indexOf('wv') > -1 || (ua.indexOf('android') > -1 && ua.indexOf('chrome') === -1);
      
      return {
        isPDFLikelySupported: (isChrome || isFirefox || isSafari || isEdge || isApple) && !isWebView,
        isWebView: isWebView,
        browserType: isChrome ? 'chrome' : isFirefox ? 'firefox' : isSafari ? 'safari' : isEdge ? 'edge' : 'other'
      };
    }
    
    if (pdfObject && loadingIndicator) {
      // Get PDF support info
      const pdfSupport = checkPDFSupport();
      
      // Add data attribute for styling
      document.body.setAttribute('data-pdf-support', pdfSupport.isPDFLikelySupported ? 'supported' : 'unsupported');
      document.body.setAttribute('data-browser', pdfSupport.browserType);
      
      // Set initial state
      pdfObject.style.opacity = 0.4;
      pdfObject.style.transition = 'opacity 0.3s ease';
      
      // If we suspect PDF might not be supported, show warning immediately
      if (!pdfSupport.isPDFLikelySupported) {
        if (pdfSupportMessage) {
          pdfSupportMessage.style.display = 'block';
        }
        if (pdfFallbackLinks) {
          pdfFallbackLinks.style.display = 'block';
          document.getElementById('pdfSupportNotice').innerHTML = '<strong>Your browser may not support PDF viewing</strong> - Please use these options:';
        }
      }
      
      // Handle successful load
      pdfObject.addEventListener('load', function() {
        this.style.opacity = 1;
        loadingIndicator.style.display = 'none';
        // Hide warning if PDF loads successfully despite our suspicions
        if (pdfSupportMessage) pdfSupportMessage.style.display = 'none';
      });
      
      // Google Viewer button
      if (useGoogleViewerBtn) {
        useGoogleViewerBtn.addEventListener('click', function() {
          const pdfUrl = encodeURIComponent(window.location.origin + '/uploads/<%= file %>');
          const googleViewerUrl = `https://docs.google.com/viewer?url=${pdfUrl}&embedded=true`;
          window.open(googleViewerUrl, '_blank');
        });
        
        // Show Google viewer option for WebView
        if (pdfSupport.isWebView) {
          useGoogleViewerBtn.style.display = 'inline-block';
        }
      }
      
      // Advanced error detection - check if PDF is blocked after a delay
      setTimeout(function() {
        try {
          // Try to access the object's content document
          const objDoc = pdfObject.contentDocument || (pdfObject.contentWindow && pdfObject.contentWindow.document);
          
          // If we can't access it or if there's no content, it might be blocked
          if (!objDoc || objDoc.body.innerHTML === '') {
            console.log('PDF may be blocked - showing fallback options');
            
            if (pdfFallbackLinks) {
              pdfFallbackLinks.style.display = 'block';
              // Make buttons more prominent
              pdfFallbackLinks.querySelector('.pdf-action-buttons').classList.add('mt-3', 'mb-3');
              document.querySelectorAll('#pdfFallbackLinks .btn').forEach(btn => {
                btn.classList.remove('btn-sm');
              });
            }
            
            if (pdfSupportMessage) {
              pdfSupportMessage.style.display = 'block';
            }
            
            loadingIndicator.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                PDF viewer cannot be loaded
              </div>
            `;
          }
        } catch (e) {
          // Access denied error means the PDF is being displayed in a sandboxed mode
          // This is actually good - it means the PDF is loading
          console.log('PDF access restricted (normal security behavior)');
          loadingIndicator.style.display = 'none';
        }
      }, 2000);
    }
    
    // Add smooth scroll behavior for better UX
    document.querySelectorAll('.performance-section').forEach(section => {
      section.style.scrollBehavior = 'smooth';
    });
    
    function adjustHeights() {
      const windowHeight = window.innerHeight;
      const headerOffset = 200; // Approximate height of headers
      const isMobile = window.innerWidth <= 768;
      
      const performanceSection = document.getElementById('performanceSection');
      const questionPaperSection = document.getElementById('questionPaperSection');
      
      if (performanceSection && questionPaperSection) {
        const availableHeight = windowHeight - headerOffset;
        performanceSection.style.height = `${availableHeight}px`;
        
        // Set PDF viewer height based on device
        let pdfViewerHeight;
        if (isMobile) {
          // Mobile: smaller height
          pdfViewerHeight = Math.min(windowHeight * 0.25, 200); // 25% of viewport or max 200px
        } else {
          // Desktop: larger height
          pdfViewerHeight = Math.min(windowHeight * 0.30, 250); // 30% of viewport or max 250px
        }
        
        questionPaperSection.style.maxHeight = `${pdfViewerHeight}px`;
        
        // Ensure the PDF viewer isn't covering important content
        const extraPadding = isMobile ? 120 : 50; // More extra padding for mobile
        performanceSection.style.paddingBottom = `${pdfViewerHeight + extraPadding}px`;
        
        // Adjust PDF viewer elements height
        const pdfViewer = questionPaperSection.querySelector('object, iframe, embed');
        if (pdfViewer) {
          pdfViewer.style.height = `${pdfViewerHeight - (isMobile ? 100 : 120)}px`; // Allow space for header and buttons
        }
        
        // Add extra margin to the last card
        const cards = document.querySelectorAll('.question-analysis-card');
        if (cards.length > 0) {
          const lastCard = cards[cards.length - 1];
          lastCard.style.marginBottom = `${pdfViewerHeight + (isMobile ? 60 : 40)}px`;
        }
        
        // Make sure all important content is visible
        const allSections = document.querySelectorAll('.student-performance-section .row');
        if (allSections.length > 0) {
          const lastSection = allSections[allSections.length - 1];
          lastSection.style.marginBottom = `${pdfViewerHeight + (isMobile ? 80 : 60)}px`;
        }
        
        // Mobile-specific adjustments
        if (isMobile) {
          // If the PDF section is collapsed, add less padding
          if (questionPaperSection.classList.contains('collapsed')) {
            performanceSection.style.paddingBottom = '50px';
          }
          
          // Make the main container taller to allow scrolling
          document.querySelector('.container-fluid:last-of-type').style.marginBottom = `${pdfViewerHeight + 50}px`;
        }
      }
    }
    
    function initZoom() {
      const zoomInBtn = document.getElementById('zoomIn');
      const zoomOutBtn = document.getElementById('zoomOut');
      const resetBtn = document.getElementById('resetZoom');
      const pdfViewer = document.getElementById('questionPaperObject') || document.querySelector('.pdf-container iframe') || document.querySelector('.pdf-container embed');
      
      if (zoomInBtn && zoomOutBtn && resetBtn && pdfViewer) {
        // Store original dimensions
        const originalHeight = pdfViewer.height || '300px';
        let zoomLevel = 100;
        
        // Zoom in
        zoomInBtn.addEventListener('click', function() {
          if (zoomLevel < 200) { // Limit zoom
            zoomLevel += 20;
            updateZoom();
          }
        });
        
        // Zoom out
        zoomOutBtn.addEventListener('click', function() {
          if (zoomLevel > 60) { // Limit zoom out
            zoomLevel -= 20;
            updateZoom();
          }
        });
        
        // Reset zoom
        resetBtn.addEventListener('click', function() {
          zoomLevel = 100;
          updateZoom();
        });
        
        // Helper function to update zoom
        function updateZoom() {
          const newHeight = parseInt(originalHeight) * (zoomLevel/100);
          pdfViewer.style.height = `${newHeight}px`;
          console.log(`PDF zoom set to ${zoomLevel}%`);
        }
      }
    }
    
    // Show scroll indicators when needed
    document.querySelectorAll('.row.g-0').forEach(row => {
      if (row.scrollWidth > row.clientWidth) {
        const indicator = row.querySelector('.scroll-indicator');
        if (indicator) {
          indicator.style.display = 'block';
        }
      }
    });
  });
</script>

<!-- Data mapping and sorting moved to the top of the template -->

<!-- Question cards are now rendered directly in the performance section -->

<!-- Duplicate templates removed - cards are rendered directly in performance section -->
 


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/368eb67b69.js" crossorigin="anonymous"></script>
    <script>
        window.onload = function() {
            // Show main content
            document.querySelector('.loader').style.display = "none";
            document.querySelector('.wholecontainer').style.display = "block";
            
            // Check for Android WebView and PDF rendering capabilities
            detectBrowserCapabilities();
        }
        
        // Detect browser PDF capabilities
        function detectBrowserCapabilities() {
            // Check if running in Android WebView
            const isAndroidWebView = 
                navigator.userAgent.indexOf('wv') > -1 || 
                (navigator.userAgent.indexOf('Android') > -1 && navigator.userAgent.indexOf('Chrome') === -1);
                
            // Check for Microsoft Edge (which has PDF rendering issues sometimes)
            const isEdge = navigator.userAgent.indexOf('Edg/') !== -1;
            
            if (isAndroidWebView) {
                document.body.classList.add('android-webview');
                
                // Show Android WebView specific elements
                document.querySelectorAll('.android-webview-only').forEach(el => {
                    el.style.display = 'block';
                });
                
                // Hide PDF object for WebView to prevent auto-download
                const pdfObject = document.getElementById('questionPaperObject');
                if (pdfObject) {
                    pdfObject.style.display = 'none';
                }
            }
            
            if (isEdge) {
                document.body.classList.add('browser-edge');
            }
        }
        
        // Unified layout and PDF handling
        document.addEventListener('DOMContentLoaded', function() {
            // Set up PDF controls and loading
            const loadingIndicator = document.getElementById('pdfLoadingIndicator');
            const pdfViewer = document.querySelector('#questionPaperObject, .pdf-viewer');
            
            if (pdfViewer && loadingIndicator) {
                pdfViewer.onload = function() {
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 300);
                };
                
                // Handle PDF load error (show fallback)
                pdfViewer.onerror = function() {
                    const fallbackLinks = document.getElementById('pdfFallbackLinks');
                    if (fallbackLinks) {
                        fallbackLinks.style.display = 'block';
                    }
                };
            }
            
            // Handle layout
            const performanceSection = document.getElementById('performanceSection');
            const questionPaperSection = document.getElementById('questionPaperSection');
            const analysisTable = document.getElementById('analysisTable');
            
            if (performanceSection && questionPaperSection && analysisTable) {
                // Handle scroll behavior
                performanceSection.addEventListener('scroll', function(e) {
                    // Keep the question paper section fixed when scrolling the performance section
                    e.stopPropagation();
                });
                
                // Adjust all layouts initially
                adjustLayout();
                
                // Re-adjust on window resize
                window.addEventListener('resize', adjustLayout);
                
                // Set up mobile-specific layout
                setupMobileLayout();
                
                // Set up PDF zoom controls
                initPDFZoom();
                
                // Handle PDF display for different environments
                handlePDFDisplay();
                
                // Handle sticky behavior
                handleStickyQuestionPaper();
            }
            
            // Function to handle the question paper as a fixed footer
            function handleStickyQuestionPaper() {
                const questionPaperSection = document.getElementById('questionPaperSection');
                const performanceSection = document.getElementById('performanceSection');
                
                if (!questionPaperSection || !performanceSection) return;
                
                // Always make the question paper sticky (fixed at bottom)
                questionPaperSection.classList.add('sticky');
                
                // Ensure the performance section has enough padding to see all content
                const paperHeight = questionPaperSection.offsetHeight;
                performanceSection.style.paddingBottom = (paperHeight + 20) + 'px';
                
                // Adjust iframe height based on available viewport space
                function adjustIframeHeight() {
                    const viewportHeight = window.innerHeight;
                    const maxIframeHeight = Math.max(200, viewportHeight * 0.4); // Max 40% of viewport
                    
                    const iframe = questionPaperSection.querySelector('iframe');
                    if (iframe) {
                        iframe.style.height = (maxIframeHeight - 80) + 'px'; // Subtract space for controls
                    }
                }
                
                // Listen for resize events to adjust iframe height
                window.addEventListener('resize', adjustIframeHeight);
                
                // Initial adjustment
                adjustIframeHeight();
            }
            
            // Function to adjust layout dimensions
            function adjustLayout() {
                const isMobile = window.innerWidth <= 1200;
                
                if (!isMobile) {
                    // Desktop layout
                    const windowHeight = window.innerHeight;
                    const headerHeight = 200;
                    const availableHeight = windowHeight - headerHeight;
                    
                    performanceSection.style.height = `${availableHeight}px`;
                    questionPaperSection.style.height = `${availableHeight}px`;
                    
                    const iframe = questionPaperSection.querySelector('iframe');
                    if (iframe) {
                        iframe.style.height = `${availableHeight - 180}px`;
                    }
                } else {
                    // Mobile layout is handled in setupMobileLayout()
                }
            }
            
            // Initialize PDF zoom controls
            function initPDFZoom() {
                const zoomIn = document.getElementById('zoomIn');
                const zoomOut = document.getElementById('zoomOut');
                const resetZoom = document.getElementById('resetZoom');
                
                let currentZoom = 100;
                
                if (zoomIn && zoomOut && resetZoom) {
                    zoomIn.addEventListener('click', function() {
                        currentZoom += 10;
                        updateZoom();
                    });
                    
                    zoomOut.addEventListener('click', function() {
                        currentZoom = Math.max(currentZoom - 10, 50);
                        updateZoom();
                    });
                    
                    resetZoom.addEventListener('click', function() {
                        currentZoom = 100;
                        updateZoom();
                    });
                    
                    function updateZoom() {
                        iframe.style.transform = `scale(${currentZoom / 100})`;
                        iframe.style.transformOrigin = 'top center';
                    }
                }
            }
        });
    </script>
    <script>
    function setupMobileLayout() {
        // Check if device is mobile
        const isMobile = window.innerWidth <= 1200;
        
        // Check if running in Android WebView
        const isAndroidWebView = 
            navigator.userAgent.indexOf('wv') > -1 || 
            navigator.userAgent.indexOf('Android') > -1 && navigator.userAgent.indexOf('Chrome') === -1;
        
        // Add relevant classes to the body
        document.body.classList.toggle('is-mobile', isMobile);
        document.body.classList.toggle('android-webview', isAndroidWebView);
        
        // Show WebView specific elements if needed
        if (isAndroidWebView) {
            document.querySelectorAll('.android-webview-only').forEach(el => {
                el.style.display = 'block';
            });
        }
        
        const questionPaperSection = document.getElementById('questionPaperSection');
        const performanceSection = document.getElementById('performanceSection');
        const pdfViewer = document.querySelector('#questionPaperSection object, #questionPaperSection iframe, #questionPaperSection embed');
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        
        if (questionPaperSection && performanceSection) {
            // Make sure navigation elements stay on top
            if (header) header.style.zIndex = "1001"; 
            if (nav) nav.style.zIndex = "1001";
            
            // Adjust layout based on screen size
            adjustHeights();
            
            // Initialize paper in collapsed state on mobile
            if (isMobile) {
                questionPaperSection.classList.add('collapsed');
            }
            
            // Create toggle handle if it doesn't exist
            if (!document.querySelector('.paper-toggle-handle')) {
                const toggleHandle = document.createElement('div');
                toggleHandle.className = 'paper-toggle-handle';
                toggleHandle.setAttribute('aria-label', 'Toggle question paper');
                questionPaperSection.prepend(toggleHandle);
                
                // Add toggle functionality on click
                toggleHandle.addEventListener('click', function() {
                    questionPaperSection.classList.toggle('collapsed');
                    
                    // Update layout after toggle
                    setTimeout(adjustHeights, 300);
                });
                
                // Enable swipe up/down for the paper section on touch devices
                let touchStartY = 0;
                let touchStartTime = 0;
                
                function handleTouchStart(evt) {
                    touchStartY = evt.touches[0].clientY;
                    touchStartTime = Date.now();
                }
                
                function handleTouchMove(evt) {
                    if (!touchStartY) return;
                    
                    const touchEndY = evt.touches[0].clientY;
                    const touchEndTime = Date.now();
                    const yDiff = touchStartY - touchEndY;
                    const timeDiff = touchEndTime - touchStartTime;
                    
                    // Only register as a swipe if it's fast enough and long enough
                    if (timeDiff < 300 && Math.abs(yDiff) > 30) {
                        if (yDiff > 0) {
                            // Swipe up - expand PDF
                            questionPaperSection.classList.remove('collapsed');
                        } else {
                            // Swipe down - collapse PDF
                            questionPaperSection.classList.add('collapsed');
                        }
                        
                        // Update layout after toggle
                        setTimeout(adjustHeights, 300);
                    }
                    
                    // Reset values
                    touchStartY = 0;
                }
                
                // Add touch event listeners
                questionPaperSection.addEventListener('touchstart', handleTouchStart, {passive: true});
                questionPaperSection.addEventListener('touchmove', handleTouchMove, {passive: true});
            }
            
            // Function to properly adjust heights for all elements
            function adjustHeights() {
                const viewportHeight = window.innerHeight;
                const isCollapsed = questionPaperSection.classList.contains('collapsed');
                
                // Set PDF viewer height based on device and state
                let pdfHeight = isMobile ? 
                    Math.min(250, viewportHeight * 0.3) : // Mobile: 30% of viewport, max 250px
                    Math.min(350, viewportHeight * 0.35);  // Desktop: 35% of viewport, max 350px
                
                // Adjust section height
                questionPaperSection.style.height = `${pdfHeight}px`;
                questionPaperSection.style.zIndex = "95"; // Keep lower than nav/header
                
                // Adjust PDF viewer element height
                if (pdfViewer) {
                    pdfViewer.style.height = `${pdfHeight - 80}px`; // Leave space for controls
                }
                
                // Set appropriate padding/margin for content sections
                let bottomSpace = isCollapsed ? 50 : pdfHeight + 30;
                performanceSection.style.paddingBottom = `${bottomSpace}px`;
                
                // Ensure student performance section has enough margin
                const studentPerformanceSection = document.querySelector('.student-performance-section');
                if (studentPerformanceSection) {
                    studentPerformanceSection.style.marginBottom = `${bottomSpace}px`;
                }
                
                // Add margin to last container to prevent content being hidden
                const lastContainer = document.querySelector('.container-fluid:last-of-type');
                if (lastContainer) {
                    lastContainer.style.marginBottom = `${bottomSpace}px`;
                }
            }
            
            // Update heights on window resize
            window.addEventListener('resize', adjustHeights);
            
            // Initial height adjustment
            adjustHeights();
        }
    }
            // On scroll, add shadow to question paper
            window.addEventListener('scroll', function() {
              if (window.scrollY > 10) {
                questionPaperSection.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
              } else {
                questionPaperSection.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.1)';
              }
            });
            
            // Add toggle button for mobile
            const toggleButton = document.createElement('button');
            toggleButton.className = 'd-md-none btn btn-sm btn-outline-primary position-absolute';
            toggleButton.style.right = '10px';
            toggleButton.style.top = '10px';
            toggleButton.style.zIndex = '1010';
            toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
            
            let isPaperMinimized = false;
            
            toggleButton.addEventListener('click', function() {
              if (isPaperMinimized) {
                // Expand
                questionPaperSection.style.height = `${paperHeight}px`;
                performanceSection.style.marginTop = `${paperHeight}px`;
                toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
              } else {
                // Minimize
                questionPaperSection.style.height = '40px';
                performanceSection.style.marginTop = '40px';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
              }
              
              isPaperMinimized = !isPaperMinimized;
            });
            
            questionPaperSection.appendChild(toggleButton);
          }
        }
      }
    </script>

    <script>
    // Initialize the question paper modal functionality
    document.addEventListener('DOMContentLoaded', function() {
      const openQuestionPaperBtn = document.getElementById('openQuestionPaperBtn');
      const questionPaperModal = document.getElementById('questionPaperModal');
      const pdfContainer = questionPaperModal.querySelector('.pdf-container');
      
      if (openQuestionPaperBtn && questionPaperModal) {
        const modal = new bootstrap.Modal(questionPaperModal);
        
        openQuestionPaperBtn.addEventListener('click', function() {
          // Load PDF content if not already loaded
          if (!pdfContainer.innerHTML.trim() && '<%= fileStatus %>' !== 'missing' && '<%= fileStatus %>' !== 'default') {
            pdfContainer.innerHTML = `
              <object data="/uploads/<%= file %>" type="application/pdf" width="100%" height="100%" style="border: none;">
                <p>Unable to display PDF. <a href="/uploads/<%= file %>" target="_blank">Download</a> instead.</p>
              </object>
            `;
          }
          modal.show();
        });
      }
    });

    // Function to check if browser supports PDF embedding
    function supportsPdfEmbedding() {
      // Test for PDF embedding support
      const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
      const isChrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1 && !isAndroidWebView();
      const isEdge = navigator.userAgent.toLowerCase().indexOf('edg') > -1;
      const isSafari = navigator.userAgent.toLowerCase().indexOf('safari') > -1 && !isChrome;
      
      // Most modern browsers support PDF embedding except some mobile browsers
      return isFirefox || isChrome || isEdge || isSafari;
    }
    
    // Function to detect if using Android WebView
    function isAndroidWebView() {
      const userAgent = navigator.userAgent.toLowerCase();
      return /wv/.test(userAgent) || 
             (/android/.test(userAgent) && /chrome/.test(userAgent) && !(/chrome\/[\d.]/.test(userAgent)));
    }
    
    // Check if PDF was already loaded once in this session - prevents multiple downloads
    function hasPdfAlreadyLoaded() {
      // We'll use localStorage for a more persistent flag across page refreshes
      return localStorage.getItem('pdfAlreadyLoadedFor_<%= file %>') === 'true';
    }
    
    // Function to modify PDF loading to prevent download prompts
    function handlePDFDisplay() {
      const iframe = document.getElementById('questionPaperObject');
      const container = document.querySelector('.pdf-container');
      
      // Mark that this PDF was loaded in this session
      if (isAndroidWebView()) {
        localStorage.setItem('pdfAlreadyLoadedFor_<%= file %>', 'true');
      }
      
      // Check if we're returning from a PDF view within the last 10 seconds
      const pdfOpened = sessionStorage.getItem('pdfOpened');
      const pdfOpenedTime = parseInt(sessionStorage.getItem('pdfOpenedTime') || '0');
      const currentTime = new Date().getTime();
      const isReturningFromPdf = pdfOpened === 'true' && (currentTime - pdfOpenedTime < 10000);
      
      if (isReturningFromPdf) {
        console.log('Detected return from PDF view, preventing automatic PDF loading');
        // Clear the flag since we've handled it
        sessionStorage.removeItem('pdfOpened');
        
        // If we're in an iframe or Android WebView, don't auto-load the PDF
        if (window !== window.parent || /wv/.test(navigator.userAgent.toLowerCase())) {
          if (container) {
            // Replace with a button to load PDF if needed
            const loadButton = document.createElement('div');
            loadButton.className = 'text-center p-3';
            loadButton.innerHTML = `
              <p class="mb-2">PDF was already viewed.</p>
              <button id="reload-pdf" class="btn btn-outline-primary">
                <i class="fas fa-sync me-2"></i> Load PDF Again
              </button>
            `;
            
            // Only replace content if this is the desktop PDF container (not modal)
            if (!container.closest('#questionPaperModal')) {
              container.innerHTML = '';
              container.appendChild(loadButton);
              
              // Add event listener to reload PDF if needed
              document.getElementById('reload-pdf').addEventListener('click', function() {
                sessionStorage.removeItem('pdfOpened');
                location.reload();
              });
            }
          }
          return;
        }
      }
      
      if (!iframe || !container) return;
      
      // For Android WebView, use different approach to display PDFs
      if (isAndroidWebView()) {
        // Create a warning/note for users
        const webviewNote = document.createElement('div');
        webviewNote.className = 'alert alert-info mb-2 small';
        webviewNote.innerHTML = '<i class="fas fa-info-circle me-1"></i> Using PDF.js compatible mode for Android WebView';
        
        // Add note before iframe
        container.insertBefore(webviewNote, container.firstChild);
        
        // Check if we should use PDF.js viewer instead of direct embed
        const usePdfJs = true; // Always use PDF.js for Android WebView
        
        if (usePdfJs) {
          // Hide the original iframe
          iframe.style.display = 'none';
          
          // Create a button to open in PDF.js viewer
          const pdfJsButton = document.createElement('div');
          pdfJsButton.className = 'text-center p-3';
          pdfJsButton.innerHTML = `
            <p class="mb-2">For best viewing experience on Android:</p>
            <a href="/web/viewer.html?file=${encodeURIComponent('/uploads/' + pdfFile)}" class="btn btn-primary" target="_blank">
              <i class="fas fa-file-pdf me-2"></i> Open with PDF.js Viewer
            </a>
          `;
          container.appendChild(pdfJsButton);
        } else {
          // Update iframe source with additional parameters
          const currentSrc = iframe.src;
          iframe.src = currentSrc + '#view=FitH&toolbar=0&navpanes=0&embedded=true';
        }
        
        // Add fallback options if iframe fails
        iframe.onerror = function() {
          iframe.style.display = 'none';
          
          const fallbackMsg = document.createElement('div');
          fallbackMsg.className = 'alert alert-warning text-center p-3';
          fallbackMsg.innerHTML = '<i class="fas fa-file-pdf me-2"></i> Click the "View Fullscreen" button below to open the question paper';
          
          container.appendChild(fallbackMsg);
        };
      }
    }
    
    // Handle page visibility changes to manage back button behavior
    function setupPageVisibilityHandler() {
      // Handle browser visibility changes
      let wasHidden = false;
      
      document.addEventListener('visibilitychange', function() {
        // When page becomes visible again after being hidden (potential back navigation)
        if (document.visibilityState === 'visible' && wasHidden) {
          wasHidden = false;
          
          // If returning within 5 seconds of opening PDF
          const pdfOpened = sessionStorage.getItem('pdfOpened');
          const pdfOpenedTime = parseInt(sessionStorage.getItem('pdfOpenedTime') || '0');
          const currentTime = new Date().getTime();
          
          if (pdfOpened === 'true' && (currentTime - pdfOpenedTime < 5000)) {
            console.log('Page became visible again after opening PDF, preventing reload');
            // Set a flag to prevent reload
            sessionStorage.setItem('preventReload', 'true');
          }
        }
        
        if (document.visibilityState === 'hidden') {
          wasHidden = true;
        }
      });
      
      // Handle window focus changes
      window.addEventListener('focus', function() {
        // When window regains focus (potential return from PDF)
        const pdfOpened = sessionStorage.getItem('pdfOpened');
        const pdfOpenedTime = parseInt(sessionStorage.getItem('pdfOpenedTime') || '0');
        const currentTime = new Date().getTime();
        
        if (pdfOpened === 'true' && (currentTime - pdfOpenedTime < 5000)) {
          console.log('Window refocused after opening PDF, disabling auto-reload');
          // Mark as handled
          sessionStorage.setItem('pdfOpened', 'handled');
        }
      });
      
      // Handle Android back button
      window.addEventListener('popstate', function(e) {
        // If returning from PDF view
        const pdfOpened = sessionStorage.getItem('pdfOpened');
        if (pdfOpened === 'true' || pdfOpened === 'handled') {
          console.log('Popstate detected after PDF view');
          // Prevent default behavior on Android WebView
          if (/wv/.test(navigator.userAgent.toLowerCase())) {
            e.preventDefault();
            sessionStorage.removeItem('pdfOpened');
            
            // Prevent reload without refreshing the page
            history.pushState(null, '', window.location.href);
          }
        }
      });
    }
    
    // Call the PDF display handler when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Set up visibility handling for PDF back button
      setupPageVisibilityHandler();
      
      // Prevent auto-download of PDF when page loads for ALL devices, not just Android WebView
      try {
        // Check if we've just returned from viewing a PDF
        const pdfViewed = sessionStorage.getItem('pdfViewed') === 'true' || 
                         localStorage.getItem('pdfViewed') === 'true';
        
        if (pdfViewed) {
          console.log("PDF was previously viewed, not auto-loading");
          // Clear the flag after checking
          sessionStorage.removeItem('pdfViewed');
          localStorage.removeItem('pdfViewed');
        }
      } catch (e) {
        console.warn('Error checking storage:', e);
      }
      
      // Special handling for Android WebView to prevent PDF auto-download
      const isWebView = isAndroidWebView();
      const pdfWasAlreadyLoaded = hasPdfAlreadyLoaded();
      
      // For Android WebView, only load the PDF on first visit, not after returning
      if (isWebView && pdfWasAlreadyLoaded) {
        console.log('Android WebView: PDF was previously loaded, preventing auto-download');
        
        // Remove any auto-loading PDF elements
        const pdfObjects = document.querySelectorAll('object[data*=".pdf"], embed[src*=".pdf"], iframe[src*=".pdf"]');
        pdfObjects.forEach(obj => {
          // Replace with a placeholder
          const parent = obj.parentElement;
          if (parent) {
            const placeholder = document.createElement('div');
            placeholder.className = 'pdf-placeholder p-4 text-center bg-light';
            placeholder.innerHTML = `
              <p><i class="fas fa-file-pdf fa-2x text-primary mb-3"></i></p>
              <p>Click the button below to view the question paper</p>
            `;
            parent.replaceChild(placeholder, obj);
          }
        });
      } else {
        // Check if we should prevent automatic PDF loading
        const preventReload = sessionStorage.getItem('preventReload');
        if (preventReload === 'true') {
          console.log('Preventing PDF reload after returning from PDF view');
          sessionStorage.removeItem('preventReload');
        } else {
          handlePDFDisplay();
        }
      }
      
      setupMobileQuestionPaperModal();
      // other existing code
    });
    
    // Mobile question paper modal functionality
    function setupMobileQuestionPaperModal() {
      const openQuestionPaperBtn = document.getElementById('openQuestionPaperBtn');
      const questionPaperModal = document.getElementById('questionPaperModal');
      const pdfFile = '<%= file %>';
      const pdfModalContainer = document.querySelector('.pdf-modal-container');
      
      if (!openQuestionPaperBtn || !questionPaperModal || !pdfModalContainer) return;
      
      // Create Bootstrap modal object
      const modal = new bootstrap.Modal(questionPaperModal);
      
      // Check if running in Android WebView
      const isWebView = isAndroidWebView();
      
      // Configure "Load Question Paper" button in modal to use PDF.js viewer
      const loadModalPdfBtn = document.getElementById('loadModalPdf');
      if (loadModalPdfBtn) {
        loadModalPdfBtn.addEventListener('click', function() {
          // Hide loading controls
          document.getElementById('modalPdfViewerControls').style.display = 'none';
          // Show PDF.js link
          document.getElementById('pdfJsViewerLink').style.display = 'block';
          
          // Create iframe to PDF.js viewer
          const timestamp = new Date().getTime();
          const pdfJsViewerUrl = `/web/viewer.html?file=${encodeURIComponent('/uploads/' + pdfFile)}&t=${timestamp}`;
          
          const iframe = document.createElement('iframe');
          iframe.src = pdfJsViewerUrl;
          iframe.style.width = '100%';
          iframe.style.height = '80vh';
          iframe.style.border = 'none';
          
          const modalPdfContainer = document.getElementById('modalPdfContainer');
          modalPdfContainer.innerHTML = '';
          modalPdfContainer.appendChild(iframe);
          
          // Hide loading indicator
          document.getElementById('modalPdfLoadingIndicator').style.display = 'none';
        });
      }
      
      // Handle button click to open PDF directly in a new tab instead of opening modal
      openQuestionPaperBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent default behavior

        // Set flags in sessionStorage to indicate PDF was opened and prevent auto-download on return
        try {
          sessionStorage.setItem('pdfOpened', 'true');
          sessionStorage.setItem('pdfOpenedTime', new Date().getTime());
          sessionStorage.setItem('preventPdfDownload', 'true');
          sessionStorage.setItem('pdfViewed', 'true');
          localStorage.setItem('pdfViewed', 'true'); // Fallback for some WebView implementations
          // Also store the PDF filename to know which one was viewed
          sessionStorage.setItem('lastViewedPdf', pdfFile);
        } catch(e) {
          console.warn('Could not set storage markers:', e);
        }
        
        // Always use PDF.js for WebView to ensure best compatibility and no downloads
        if (isWebView || !supportsPdfEmbedding()) {
          console.log("Using PDF.js viewer for best compatibility");
          // PDF.js viewer URL with a timestamp to prevent caching on Android WebView
          const timestamp = new Date().getTime();
          const pdfJsViewerUrl = `/web/viewer.html?file=${encodeURIComponent('/uploads/' + pdfFile)}&t=${timestamp}`;
          
          
          // Open in a way that works best with Android WebView
          try {
            // Try window.open first - this works better in many WebView implementations
            const newWindow = window.open(pdfJsViewerUrl, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
              // If window.open failed, try location.href as fallback
              window.location.href = pdfJsViewerUrl;
            }
          } catch (e) {
            // If all else fails, try direct assignment to location
            console.error("Error opening PDF.js viewer:", e);
            window.location.href = pdfJsViewerUrl;
          }
          return;
        }
        
        // For regular browsers, check PDF support
        const isPDFSupported = () => {
          const isChrome = navigator.userAgent.indexOf("Chrome") > -1;
          const isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
          const isSafari = navigator.userAgent.indexOf("Safari") > -1 && navigator.userAgent.indexOf("Chrome") === -1;
          const isEdge = navigator.userAgent.indexOf("Edg") > -1;
          
          // Most modern browsers support PDF viewing
          return isChrome || isFirefox || isSafari || isEdge;
        };

        // For browsers with limited PDF support, use PDF.js viewer
        if (!isPDFSupported()) {
          // PDF.js viewer URL with full path to PDF - works without downloading
          const timestamp = new Date().getTime(); // Add timestamp to prevent caching issues
          const pdfJsViewerUrl = `/web/viewer.html?file=${encodeURIComponent('/uploads/' + pdfFile)}&t=${timestamp}`;
          
          // Save markers to prevent auto-downloads when returning
          try {
            sessionStorage.setItem('preventPdfDownload', 'true');
            sessionStorage.setItem('pdfViewed', 'true');
            localStorage.setItem('pdfViewed', 'true'); // Fallback for some browser implementations
            sessionStorage.setItem('lastViewedPdf', pdfFile);
          } catch(e) {
            console.warn('Could not set storage markers:', e);
          }
          
          console.log('Opening PDF in PDF.js viewer:', pdfJsViewerUrl);
          
          // Open in a new tab using the PDF.js viewer (prevents auto-download)
          window.open(pdfJsViewerUrl, '_blank');
        } else {
          // Direct PDF link for browsers that support it
          console.log('Opening PDF directly:', '/uploads/' + pdfFile);
          window.open('/uploads/' + pdfFile, '_blank');
        }
      });
      
      // Original modal code kept for reference but not used
      /* Original Modal Code - Disabled in favor of direct link behavior
      function openQuestionPaperModal() {
        // Clear any previous content except the loading spinner
        const spinner = pdfModalContainer.querySelector('.pdf-loading');
        if (spinner) {
          // Keep spinner, remove anything else
          Array.from(pdfModalContainer.children).forEach(child => {
            if (!child.classList.contains('pdf-loading')) {
              child.remove();
            }
          });
        } else {
          // Clear completely and add spinner
          pdfModalContainer.innerHTML = '';
          const loadingSpinner = document.createElement('div');
          loadingSpinner.className = 'd-flex flex-column justify-content-center align-items-center h-100 pdf-loading';
          loadingSpinner.innerHTML = `
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading question paper...</div>
          `;
          pdfModalContainer.appendChild(loadingSpinner);
        }
        
        // Use the History API to handle the back button
        const modalState = { modal: 'questionPaper' };
        history.pushState(modalState, '', window.location.pathname + window.location.search + '#questionPaper');
        
        // Open the modal
        modal.show();
        
        // Use setTimeout to make the spinner visible before loading PDF
        setTimeout(() => {
          if (isWebView) {
            try {
              // For Android WebView, use an embedded Google Docs Viewer to avoid auto-download
              const iframe = document.createElement('iframe');
              // Use Google Docs Viewer as a fallback for better mobile compatibility
              const pdfUrl = encodeURIComponent(window.location.origin + '/uploads/' + pdfFile);
              iframe.src = `https://docs.google.com/viewer?url=${pdfUrl}&embedded=true`;
              iframe.setAttribute('width', '100%');
              iframe.setAttribute('height', '100%');
              iframe.setAttribute('style', 'min-height: 75vh; border: none; border-radius: 8px;');
              iframe.classList.add('pdf-viewer');
              
              // Create a direct link as backup
              const directLinkContainer = document.createElement('div');
              directLinkContainer.className = 'text-center my-2 sticky-top bg-light py-2';
              directLinkContainer.innerHTML = `
                <a href="/uploads/${pdfFile}" class="btn btn-sm btn-outline-primary" target="_blank">
                  <i class="fas fa-external-link-alt me-1"></i> Open PDF Directly
                </a>
              `;
              
              // Handle iframe load event
              iframe.onload = function() {
                console.log('PDF iframe loaded');
                const spinner = pdfModalContainer.querySelector('.pdf-loading');
                if (spinner) spinner.remove();
              };
              
              // Handle iframe error
              iframe.onerror = function(e) {
                console.error('PDF iframe error', e);
                const spinner = pdfModalContainer.querySelector('.pdf-loading');
                if (spinner) {
                  spinner.innerHTML = `
                    <div class="alert alert-warning">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Could not load PDF preview. Please use the direct link.
                    </div>
                  `;
                }
              };
              
              // Add the direct link first
              pdfModalContainer.appendChild(directLinkContainer);
              // Then add the iframe
              pdfModalContainer.appendChild(iframe);
            } catch (err) {
              console.error('Error loading PDF in WebView:', err);
              // Show enhanced error message with better options
              pdfModalContainer.innerHTML = `
                <div class="alert alert-warning mb-4">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x text-warning"></i>
                    <div>
                      <h5 class="mb-1">Unable to Display PDF</h5>
                      <p class="mb-0">Your browser doesn't support embedded PDF viewing.</p>
                    </div>
                  </div>
                </div>
                
                <div class="text-center my-4">
                  <div class="mb-4">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48IS0tIEZvbnQgQXdlc29tZSBQcm8gNi40LjAgYnkgQGZvbnRhd2Vzb21lIC0gaHR0cHM6Ly9mb250YXdlc29tZS5jb20gTGljZW5zZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tL2xpY2Vuc2UgKENvbW1lcmNpYWwgTGljZW5zZSkgQ29weXJpZ2h0IDIwMjMgRm9udGljb25zLCBJbmMuIC0tPjxwYXRoIGZpbGw9IiNlNzRjM2MiIGQ9Ik0wIDY0QzAgMjguNyAyOC43IDAgNjQgMEg0NDhDNDgzLjMgMCA1MTIgMjguNyA1MTIgNjRWMzU4LjdjMCAxNS40LTYuMSAzMC4xLTE2LjkgNDAuOUw0MDkuNCA0ODMuNkMzOTguNiA0OTQuNCAzODMuOSA1MDAgMzY4LjUgNTAwSDY0YTY0IDY0IDAgMCAxIC02NC02NFY2NHptMTI4IDBINjR2Mzg0SDM1MlYzNTJjMC0xNy43IDE0LjMtMzIgMzItMzJoNjRWNjRIMTI4em0yNTYgMjA4YTE2IDE2IDAgMSAwIDAgMzIgMTYgMTYgMCAxIDAgMC0zMnptLTg5LjktMjEuOWE3Ny44OSA3Ny44OSAwIDAgMSAyMS4xLTExLjdjMTAuNi00LjIgMTYuOC0xNS42IDEyLjUtMjYuM3MtMTUuNi0xNi44LTI2LjMtMTIuNWMtMTEgNC40LTIxLjIgMTAuNC0zMC40IDE3LjlMMjQ5LjggMjM4LjhjLTIwLjItMTAuNy00My40LTE3LTY4LTEyLjRsLTIwLjUtMjAuNUM4Mi44IDIyMy45IDM5LjEgMjQyLjggMjEuMSAyOTcuOGMtMi4xIDYuNSA0LjIgMTIuMyAxMC40IDEwLjZDODEuNiAyOTQuMiAxMzAgMzAwLjQgMTYyLjQgMzM3LjZjMi44IDMuMiA3LjUgMyAxMC4xLS40YzExLjQtMTUuMSAyNy43LTI2LjYgNDYuOC0zMC40bDQ1LjktMTYuNGMtMy4yIDUuMS01LjcgMTAuNi03LjkgMTYuMy01LjggMTYgMS4xIDMyLjggMTYuMSAzNi44YzMuOCAxIDE0LjQgMS41IDI1LjltMjUuOC05LjVhMjkuOSAyOS45IDAgMCAxIC00LjctMjMuNGM0LjUgMi40IDkgNS4xIDEzLjMgOC4yeiIvPjwvc3ZnPg==" 
                         alt="PDF Icon" style="width: 80px; height: 80px;">
                  </div>
                  <p class="mb-3">Please use one of these options:</p>
                  <div class="d-flex flex-column gap-2 align-items-center">
                    <a href="/uploads/${pdfFile}" class="btn btn-primary" target="_blank">
                      <i class="fas fa-external-link-alt me-2"></i> Open in New Tab
                    </a>
                    <a href="/uploads/${pdfFile}" class="btn btn-outline-secondary" download>
                      <i class="fas fa-download me-2"></i> Download PDF
                    </a>
                    <a href="https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin + '/uploads/' + pdfFile)}&embedded=true" 
                       class="btn btn-outline-info" target="_blank">
                      <i class="fab fa-google me-2"></i> Try Google Viewer
                    </a>
                  </div>
                </div>
              `;
            }
          } else {
          */
            try {
              // Check if browser likely supports PDF viewing
              const isPDFSupported = () => {
                const isChrome = navigator.userAgent.indexOf("Chrome") > -1;
                const isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
                const isSafari = navigator.userAgent.indexOf("Safari") > -1 && navigator.userAgent.indexOf("Chrome") === -1;
                const isEdge = navigator.userAgent.indexOf("Edg") > -1;
                
                // Most modern browsers support PDF viewing
                return isChrome || isFirefox || isSafari || isEdge;
              };
              
              // First try to detect PDF support
              const supportsPDF = isPDFSupported();
              
              // Create a container for better organization
              const viewerContainer = document.createElement('div');
              viewerContainer.className = 'pdf-viewer-container w-100';
              
              // Create PDF object with enhanced fallback
              const pdfObject = document.createElement('object');
              pdfObject.setAttribute('data', `/uploads/${pdfFile}#toolbar=0&navpanes=0&view=FitH&embedded=true`);
              pdfObject.setAttribute('type', 'application/pdf');
              pdfObject.setAttribute('width', '100%');
              pdfObject.setAttribute('height', '75vh');
              pdfObject.setAttribute('style', 'border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);');
              pdfObject.classList.add('pdf-viewer');
              
              // Enhanced fallback content with clear message
              pdfObject.innerHTML = `
                <div class="pdf-fallback-message alert alert-info p-4 text-center">
                  <div class="mb-3">
                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                    <h5>PDF Preview Not Available</h5>
                    <p>Your browser doesn't support embedded PDF viewing.</p>
                  </div>
                  <div class="d-flex flex-column gap-2 align-items-center">
                    <a href="/uploads/${pdfFile}" class="btn btn-primary" target="_blank">
                      <i class="fas fa-external-link-alt me-2"></i> Open PDF in New Tab
                    </a>
                    <a href="/uploads/${pdfFile}" class="btn btn-outline-secondary" download>
                      <i class="fas fa-download me-2"></i> Download PDF
                    </a>
                  </div>
                </div>
              `;
              
              // If we suspect the browser doesn't support PDFs, show a warning above the PDF
              if (!supportsPDF) {
                const warningBanner = document.createElement('div');
                warningBanner.className = 'alert alert-warning mb-3';
                warningBanner.innerHTML = `
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Browser PDF Support Limited</strong> - If you can't see the PDF below, please use the buttons to open or download it.
                `;
                viewerContainer.appendChild(warningBanner);
              }
              
              // Add the PDF object
              viewerContainer.appendChild(pdfObject);
              
              // Add alternative options below for all users
              const alternativeOptions = document.createElement('div');
              alternativeOptions.className = 'mt-3 pt-2 border-top text-center';
              alternativeOptions.innerHTML = `
                <p class="text-muted small mb-2">Having trouble viewing this PDF?</p>
                <div class="btn-group">
                  <a href="/uploads/${pdfFile}" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i> Open in New Tab
                  </a>
                  <a href="/uploads/${pdfFile}" class="btn btn-sm btn-outline-secondary" download>
                    <i class="fas fa-download me-1"></i> Download
                  </a>
                </div>
              `;
              viewerContainer.appendChild(alternativeOptions);
              
              // Remove spinner when PDF loads or after timeout
              pdfObject.onload = function() {
                console.log("PDF object loaded");
                const spinner = pdfModalContainer.querySelector('.pdf-loading');
                if (spinner) spinner.remove();
              };
              
              // Add a timeout to remove spinner even if onload doesn't trigger
              setTimeout(function() {
                const spinner = pdfModalContainer.querySelector('.pdf-loading');
                if (spinner) spinner.remove();
              }, 3000);
              
              pdfModalContainer.appendChild(viewerContainer);
            } catch (err) {
              console.error('Error loading PDF:', err);
              // Show enhanced error message with better options
              pdfModalContainer.innerHTML = `
                <div class="alert alert-warning mb-4">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x text-warning"></i>
                    <div>
                      <h5 class="mb-1">PDF Viewer Not Available</h5>
                      <p class="mb-0">Your browser doesn't support embedded PDF viewing.</p>
                    </div>
                  </div>
                </div>
                
                <div class="text-center my-4">
                  <div class="mb-4">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48IS0tIEZvbnQgQXdlc29tZSBQcm8gNi40LjAgYnkgQGZvbnRhd2Vzb21lIC0gaHR0cHM6Ly9mb250YXdlc29tZS5jb20gTGljZW5zZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tL2xpY2Vuc2UgKENvbW1lcmNpYWwgTGljZW5zZSkgQ29weXJpZ2h0IDIwMjMgRm9udGljb25zLCBJbmMuIC0tPjxwYXRoIGZpbGw9IiNlNzRjM2MiIGQ9Ik0wIDY0QzAgMjguNyAyOC43IDAgNjQgMEg0NDhDNDgzLjMgMCA1MTIgMjguNyA1MTIgNjRWMzU4LjdjMCAxNS40LTYuMSAzMC4xLTE2LjkgNDAuOUw0MDkuNCA0ODMuNkMzOTguNiA0OTQuNCAzODMuOSA1MDAgMzY4LjUgNTAwSDY0YTY0IDY0IDAgMCAxIC02NC02NFY2NHptMTI4IDBINjR2Mzg0SDM1MlYzNTJjMC0xNy43IDE0LjMtMzIgMzItMzJoNjRWNjRIMTI4em0yNTYgMjA4YTE2IDE2IDAgMSAwIDAgMzIgMTYgMTYgMCAxIDAgMC0zMnptLTg5LjktMjEuOWE3Ny44OSA3Ny44OSAwIDAgMSAyMS4xLTExLjdjMTAuNi00LjIgMTYuOC0xNS42IDEyLjUtMjYuM3MtMTUuNi0xNi44LTI2LjMtMTIuNWMtMTEgNC40LTIxLjIgMTAuNC0zMC40IDE3LjlMMjQ5LjggMjM4LjhjLTIwLjItMTAuNy00My40LTE3LTY4LTEyLjRsLTIwLjUtMjAuNUM4Mi44IDIyMy45IDM5LjEgMjQyLjggMjEuMSAyOTcuOGMtMi4xIDYuNSA0LjIgMTIuMyAxMC40IDEwLjZDODEuNiAyOTQuMiAxMzAgMzAwLjQgMTYyLjQgMzM3LjZjMi44IDMuMiA3LjUgMyAxMC4xLS40YzExLjQtMTUuMSAyNy43LTI2LjYgNDYuOC0zMC40bDQ1LjktMTYuNGMtMy4yIDUuMS01LjcgMTAuNi03LjkgMTYuMy01LjggMTYgMS4xIDMyLjggMTYuMSAzNi44YzMuOCAxIDE0LjQgMS41IDI1LjltMjUuOC05LjVhMjkuOSAyOS45IDAgMCAxIC00LjctMjMuNGM0LjUgMi40IDkgNS4xIDEzLjMgOC4yeiIvPjwvc3ZnPg==" 
                         alt="PDF Icon" style="width: 80px; height: 80px;">
                  </div>
                  <p class="mb-3">Please use one of these options:</p>
                  <div class="d-flex flex-column gap-2 align-items-center">
                    <a href="/uploads/${pdfFile}" class="btn btn-primary" target="_blank">
                      <i class="fas fa-external-link-alt me-2"></i> Open in New Tab
                    </a>
                    <a href="/uploads/${pdfFile}" class="btn btn-outline-secondary" download>
                      <i class="fas fa-download me-2"></i> Download PDF
                    </a>
                    <a href="https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin + '/uploads/' + pdfFile)}&embedded=true" 
                       class="btn btn-outline-info" target="_blank">
                      <i class="fab fa-google me-2"></i> Try Google Viewer
                    </a>
                  </div>
                </div>
              `;
            }
      
      // Keep the modal close listener for potential future use
      questionPaperModal.addEventListener('hidden.bs.modal', function() {
        // Clear the modal content when closed to prevent memory issues
        pdfModalContainer.innerHTML = '';
        
        if (window.location.hash === '#questionPaper') {
          history.back(); // Go back to remove the hash
        }
      });
      
      // Listen for popstate event (when back button is pressed)
      window.addEventListener('popstate', function(event) {
        if (questionPaperModal.classList.contains('show')) {
          modal.hide(); // Close the modal if it's open
        }
      });
    }
  </script>
</body>
</html>
